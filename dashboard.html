<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VALID Assessment Dashboard</title>
    <!-- Main Site Styles -->
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/layout.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/mobile.css">
    <link rel="stylesheet" href="./css/debug.css">
    <link rel="stylesheet" href="./css/dashboard.css">
    <link rel="stylesheet" href="./css/gamification.css">
    <link rel="stylesheet" href="./css/results.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/my-results.css">
    <link rel="stylesheet" href="css/profile.css">
    <link rel="stylesheet" href="css/team-management.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js for radar charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Loading State -->
    <div id="loadingState" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center;">
            <h2>Loading Dashboard...</h2>
            <p>Please wait while we load your dashboard.</p>
        </div>
    </div>

    <!-- Version Indicator -->
    <div id="versionIndicator" class="version-indicator">
        <span id="versionText">v1.0.0</span>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Dashboard Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <img src="./img/TVM_ Logo_L.png" alt="The Validated Mind Logo" class="header-logo">
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span id="userEmail">user@example.com</span>
                    </div>
                    <button class="btn primary" onclick="testGetCurrentUser()" style="background: #3b82f6; margin-right: 0.5rem;">
                        ðŸ‘¤ Test User
                    </button>
                    <button class="btn secondary" onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i>
                        Sign Out
                    </button>
                </div>
            </div>
        </header>

        <div class="dashboard-layout">
            <nav class="sidebar expanded">
                <!-- Removed sidebar-logo for a cleaner, logo-free sidebar -->
                <ul class="sidebar-menu">
                    <li class="sidebar-item active" data-section="overviewSection">
                        <i class="fas fa-home"></i>
                        <span class="sidebar-label">Overview</span>
                    </li>
                    <li class="sidebar-item" data-section="validAssessmentSection">
                        <img src="images/valid-assessment-icon.svg" class="sidebar-icon" alt="VALID Assessment">
                        <span class="sidebar-label">VALID Assessment</span>
                    </li>
                    <li class="sidebar-item" data-section="dashboardResultsSection">
                        <i class="fas fa-chart-line"></i>
                        <span class="sidebar-label">My Results</span>
                    </li>
                    <li class="sidebar-item" data-section="profileSection">
                        <i class="fas fa-user"></i>
                        <span class="sidebar-label">My Profile</span>
                    </li>
                    <li class="sidebar-item" data-section="teamSection">
                        <i class="fas fa-users"></i>
                        <span class="sidebar-label">Team Management</span>
                    </li>
                    <li class="sidebar-item" data-section="valid360Section">
                        <img src="images/valid360-icon.svg" class="sidebar-icon" alt="Valid360">
                        <span class="sidebar-label">Valid360</span>
                    </li>
                    <li class="sidebar-item" data-section="documentsSection">
                        <img src="images/upload-documents-icon.svg" class="sidebar-icon" alt="Documents">
                        <span class="sidebar-label">Documents</span>
                    </li>
                    <li class="sidebar-item" data-section="myDecisionsSection">
                        <i class="fas fa-lightbulb"></i>
                        <span class="sidebar-label">My Decisions</span>
                    </li>
                </ul>
            </nav>
            <div class="content-wrapper">
                <div class="sidebar-accent"></div>
                <main class="dashboard-content">
                    <!-- Overview Section -->
                    <div id="overviewSection" class="dashboard-section" style="display: none;">
                        <h1>Dashboard Overview</h1>
                        <p style="color: #6b7280; margin-bottom: 2rem;">Welcome to your assessment dashboard. Here's an overview of your activity and available assessments.</p>
                        <button id="startNewAssessment" class="btn primary" style="margin-bottom: 2rem;" onclick="startNewAssessment()">
                            <i class="fas fa-play"></i> Start New Assessment
                        </button>
                        <div class="dashboard-grid">
                            <!-- VALID Assessment Card -->
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <img src="./images/valid-assessment-icon.svg" alt="VALID Assessment" style="width: 48px; height: 48px;">
                                    <div>
                                        <h3 class="card-title">VALID Assessment</h3>
                                        <p class="card-subtitle">Values, Awareness, Lived Experience, Institutional Knowledge, Desire</p>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-number" id="validScore">--</div>
                                            <div class="stat-label">Your Score</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number" id="validTime">--</div>
                                            <div class="stat-label">Time Taken</div>
                                        </div>
                                    </div>
                                    <button class="btn primary" onclick="showSection('dashboardResultsSection')">
                                        <i class="fas fa-chart-bar"></i> My Results
                                    </button>
                                </div>
                            </div>

                            <!-- Valid360 Card -->
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <img src="./images/valid360-icon.svg" alt="Valid360" style="width: 48px; height: 48px;">
                                    <div>
                                        <h3 class="card-title">Valid360</h3>
                                        <p class="card-subtitle">Comprehensive feedback from multiple perspectives</p>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <div class="coming-soon">
                                        <i class="fas fa-clock"></i>
                                        Coming Soon
                                    </div>
                                    <p style="color: #6b7280; font-size: 0.875rem; margin-top: 1rem;">
                                        Our 360-degree assessment tool is currently in development. 
                                        Get comprehensive feedback from peers, managers, and direct reports.
                                    </p>
                                </div>
                            </div>

                            <!-- Upload Documents Card -->
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <img src="./images/upload-documents-icon.svg" alt="Upload Documents" style="width: 48px; height: 48px;">
                                    <div>
                                        <h3 class="card-title">Upload Documents</h3>
                                        <p class="card-subtitle">Share additional context and materials</p>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <div class="upload-area" id="uploadArea">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #6b7280; margin-bottom: 1rem;"></i>
                                        <p style="margin-bottom: 1rem;">Drag and drop files here or click to browse</p>
                                        <button class="btn secondary" onclick="document.getElementById('fileInput').click()">
                                            <i class="fas fa-folder-open"></i> Choose Files
                                        </button>
                                        <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileUpload(event)">
                                    </div>
                                    <div id="uploadedFiles" style="display: none;">
                                        <h4 style="margin-bottom: 0.5rem;">Uploaded Files:</h4>
                                        <div id="fileList"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Team Management Card -->
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <img src="./images/team-management-icon.svg" alt="Team Management" style="width: 48px; height: 48px;">
                                    <div>
                                        <h3 class="card-title">Team Management</h3>
                                        <p class="card-subtitle">Manage team members and permissions</p>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <div class="coming-soon">
                                        <i class="fas fa-clock"></i>
                                        Coming Soon
                                    </div>
                                    <p style="color: #6b7280; font-size: 0.875rem; margin-top: 1rem;">
                                        Team management features are currently in development. 
                                        Soon you'll be able to invite team members and manage their access.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- Gamification Placeholder (Decision Shuffle) -->
                        <div class="dashboard-card gamification-card" style="margin-top: 2.5rem; position: relative;">
                            <div class="gamification-vpts-tracker">
                                <span class="vpts-trophy"><i class="fas fa-trophy"></i></span>
                                <span class="vpts-label">VPTS</span>
                                <span class="vpts-value" id="validationPoints">325</span>
                            </div>
                            <div class="gamification-content">
                                <div class="gamification-left">
                                    <h2 class="gamification-title">Decision Shuffle <span class="gamification-badge">Beta</span></h2>
                                    <p class="gamification-desc">Earn points and track your decision intelligence!<br><span style="color:#64748b;font-size:1rem;">(3 new prompts every day to build your validation profile)</span></p>
                                    <div class="gamification-question">
                                        <span class="gamification-question-label">Recognition (2 pts):</span>
                                        <span class="gamification-question-text" id="recognitionQuestion">Would you want to see the numbers before buying a $500 gadget?</span>
                                    </div>
                                    <div class="gamification-question">
                                        <span class="gamification-question-label">Comparison (3 pts):</span>
                                        <span class="gamification-question-text" id="comparisonQuestion">A product with 1000 five-star reviews vs. one recommended by your best friend?</span>
                                    </div>
                                    <div class="gamification-question">
                                        <span class="gamification-question-label">Speed/Bias (5 pts):</span>
                                        <span class="gamification-question-text" id="speedQuestion">Sarah bought the iPhone because all her friends have one. What validation type is this?</span>
                                    </div>
                                    <div class="gamification-coming-soon">More features, achievements, and question types coming soon!</div>
                                </div>
                                <div class="gamification-right">
                                    <div class="gamification-image-placeholder">
                                        <i class="fas fa-brain"></i>
                                    </div>
                                    <div class="gamification-actions">
                                        <button class="gamification-btn thumbs-down" title="No">
                                            <i class="fas fa-thumbs-down"></i>
                                        </button>
                                        <button class="gamification-btn thumbs-up" title="Yes">
                                            <i class="fas fa-thumbs-up"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VALID Assessment Section -->
                    <div id="validAssessmentSection" class="dashboard-section" style="display: none;">
                        <!-- Welcome Section -->
                        <section id="welcomeSection" class="assessment-section active" style="position: relative; z-index: 1;">
                            <div class="content-card welcome-card" style="position: relative; z-index: 2;">
                                <h1 class="section-title">VALID Assessment</h1>
                                <p class="section-description">
                                    Discover how you make decisions and learn to expand your toolkit.
                                </p>
                                
                                <div class="welcome-actions" style="position: relative; z-index: 3;">
                                    <button id="startAssessment" class="btn btn-primary">Start Assessment</button>
                                    <button id="resumeAssessment" class="btn btn-secondary">Resume Assessment</button>
                                </div>
                            </div>

                            <!-- Resume Assessment Modal -->
                            <div id="resumeModal" class="modal">
                                <div class="modal-content">
                                    <h2>Resume Assessment</h2>
                                    <p class="info-text">Enter your progress token and the email address you used to save your progress.</p>
                                    <form id="resumeForm" class="popup-form">
                                        <div class="form-group">
                                            <label for="resumeToken">Progress Token</label>
                                            <input type="text" id="resumeToken" name="token" required placeholder="Paste your progress token here" class="token-input">
                                            <small>The token you received when saving your progress</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="resumeEmail">Email Address</label>
                                            <input type="email" id="resumeEmail" name="email" required placeholder="Enter your email address">
                                            <small>Must match the email used when saving progress</small>
                                        </div>
                                        <div class="form-actions">
                                            <button type="button" class="btn btn-secondary" id="cancelResume">Cancel</button>
                                            <button type="submit" class="btn btn-primary">Resume</button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Save Progress Modal -->
                            <div id="saveModal" class="modal">
                                <div class="modal-content">
                                    <h2>Save Your Progress</h2>
                                    <p class="info-text">Save this token to resume your assessment later. The token will expire in 7 days.</p>
                                    
                                    <!-- Main token display -->
                                    <div class="token-display">
                                        <input type="text" class="token-input" readonly>
                                        <button class="btn-icon copy-token" title="Copy to clipboard">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M13 0H6C4.9 0 4 0.9 4 2V3H2C0.9 3 0 3.9 0 5V14C0 15.1 0.9 16 2 16H9C10.1 16 11 15.1 11 14V13H13C14.1 13 15 12.1 15 11V2C15 0.9 14.1 0 13 0ZM9 14H2V5H9V14ZM13 11H11V5C11 3.9 10.1 3 9 3H6V2H13V11Z" fill="currentColor"/>
                                            </svg>
                                        </button>
                                    </div>

                                    <div class="token-instructions">
                                        <p>Make sure to:</p>
                                        <ul>
                                            <li>Copy and save this token somewhere safe</li>
                                            <li>You'll need this token to resume your assessment</li>
                                            <li>The token cannot be recovered if lost</li>
                                        </ul>
                                    </div>

                                    <div class="modal-actions">
                                        <button class="btn btn-secondary copy-token">Copy Token</button>
                                        <button class="btn btn-primary close-modal">Done</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Instructions Section -->
                        <section id="instructionsSection" class="assessment-section">
                            <div class="content-card">
                                <h2>Instructions</h2>
                                <p class="lead">Please read these instructions carefully before beginning the assessment.</p>

                                <div class="instructions-list">
                                    <div class="instruction-item">
                                        <h3>1. Answer Honestly</h3>
                                        <p>There are no right or wrong answers. Choose responses that best reflect your natural decision-making style.</p>
                                    </div>

                                    <div class="instruction-item">
                                        <h3>2. Response Scale</h3>
                                        <p>For each statement, indicate how characteristic it is of you:</p>
                                        <p><strong>1 = Not Very Characteristic</strong> to <strong>7 = Very Characteristic</strong></p>
                                    </div>

                                    <div class="instruction-item">
                                        <h3>3. Time Required</h3>
                                        <p>The assessment takes approximately 15-20 minutes to complete.</p>
                                    </div>

                                    <div class="instruction-item">
                                        <h3>4. Confidentiality</h3>
                                        <p>Your responses are confidential and will be used only for research and development purposes.</p>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" id="backToDemographicsButton">Â« Back</button>
                                    <button type="button" class="btn btn-primary" id="beginAssessmentButton">Begin Assessment Â»</button>
                                </div>
                            </div>
                        </section>

                        <!-- Questions Section -->
                        <section id="questionsSection" class="assessment-section" style="display: none;">
                            <div class="content-card">
                                <div class="question-container">
                                    <div class="question-header">
                                        <h2>Question <span id="questionNumber">1</span></h2>
                                        <div class="question-progress">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: 0%"></div>
                                            </div>
                                            <span class="progress-text">Question 1 of 57</span>
                                        </div>
                                    </div>

                                    <div id="questionText" class="question-text">
                                        Loading question...
                                    </div>

                                    <div class="scale-buttons">
                                        <button class="scale-button" data-value="1">
                                            1
                                            <span>Not Very Characteristic</span>
                                        </button>
                                        <button class="scale-button" data-value="2">2</button>
                                        <button class="scale-button" data-value="3">3</button>
                                        <button class="scale-button" data-value="4">4</button>
                                        <button class="scale-button" data-value="5">5</button>
                                        <button class="scale-button" data-value="6">6</button>
                                        <button class="scale-button" data-value="7">
                                            7
                                            <span>Very Characteristic</span>
                                        </button>
                                    </div>

                                    <div class="question-actions">
                                        <div class="auto-advance">
                                            <input type="checkbox" id="autoAdvance">
                                            <label for="autoAdvance">Auto-advance to next question</label>
                                        </div>
                                        <div class="navigation-buttons">
                                            <button id="prevQuestion" class="btn btn-secondary">Â« Previous</button>
                                            <button id="nextQuestion" class="btn btn-primary" disabled>Next Â»</button>
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right; margin-top: 1.5rem;">
                                    <button class="btn" onclick="resetAssessment()" style="border: 1px solid #f59e42; color: #f59e42; background: transparent; font-size: 0.95rem; padding: 0.5rem 1.2rem; border-radius: 6px;">
                                        <i class="fas fa-undo"></i> Reset Assessment
                                    </button>
                                    <span style="color: #f59e42; font-size: 0.92rem; margin-left: 0.5rem;">Caution: This will reset all your answers and cannot be undone.</span>
                                </div>
                            </div>
                        </section>

                        <!-- Completion Section -->
                        <section id="completionSection" class="assessment-section">
                            <div class="content-card">
                                <div class="completion-container text-center">
                                    <h2>Thank you for completing The Validated Mind Assessment!</h2>
                                    <p class="lead">Your responses have been recorded successfully.</p>
                                    <div class="completion-actions">
                                        <button id="viewReportButton" class="btn btn-primary">View Your Report Â»</button>
                                        <button id="downloadReportButton" class="btn btn-secondary">Download Report (PDF)</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Summary Section -->
                        <section id="summarySection" class="assessment-section">
                            <div class="content-card">
                                <h2>Review Your Answers</h2>
                                <p class="lead">Please review your answers before submitting. You can go back to any question to change your response.</p>
                                
                                <div class="summary-container">
                                    <div id="summaryList" class="summary-list">
                                        <!-- Questions will be populated here -->
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button id="returnToQuestionButton" class="btn btn-secondary">Â« Return to Questions</button>
                                    <button id="submitAssessmentButton" class="btn btn-primary">Submit Assessment Â»</button>
                                </div>
                            </div>
                        </section>

                        <!-- Results Section -->
                        <section id="resultsSection" class="assessment-section">
                            <div class="content-card">
                                <h2>Your VALID Assessment Results</h2>
                                
                                <div class="results-container">
                                    <!-- Persona Section -->
                                    <div class="persona-section">
                                        <h3>Your Decision-Making Persona</h3>
                                        <div id="personaDescription" class="persona-description">
                                            <!-- Persona details will be populated here -->
                                        </div>
                                    </div>

                                    <!-- Scores Section -->
                                    <div class="scores-section">
                                        <h3>Your VALID Scores</h3>
                                        <div class="score-bars">
                                            <!-- Score bars will be populated here -->
                                        </div>
                                    </div>

                                    <!-- Insights Section -->
                                    <div class="insights-section">
                                        <h3>Key Insights</h3>
                                        <div id="insightsContent">
                                            <!-- Insights will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- My Results Section -->
                    <div id="dashboardResultsSection" class="dashboard-section" style="display: none;">
                        <div class="actions-section" style="margin-bottom: 2rem; justify-content: flex-end;">
                            <div id="demoActions" style="display: none; align-items: center; gap: 1rem;">
                                <button class="btn primary" id="toggleDemoResultsBtn" style="background: #ef4444;">
                                    ðŸ§ª Show Demo Results
                                </button>
                            </div>
                            <div class="dropdown">
                                <button class="btn primary dropdown-toggle" id="downloadButton">
                                    <svg class="icon" viewBox="0 0 24 24" width="16" height="16">
                                        <path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                                    </svg>
                                    Download
                                    <svg class="caret" viewBox="0 0 24 24" width="12" height="12">
                                        <path fill="currentColor" d="M7 10l5 5 5-5z"></path>
                                    </svg>
                                </button>
                                <div class="dropdown-menu" id="downloadMenu">
                                    <button class="dropdown-item" id="printButton">
                                        <svg class="icon" viewBox="0 0 24 24" width="16" height="16">
                                            <path fill="currentColor" d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"></path>
                                        </svg>
                                        Print Report
                                    </button>
                                    <button class="dropdown-item" id="exportJSONButton">
                                        <svg class="icon" viewBox="0 0 24 24" width="16" height="16">
                                            <path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"></path>
                                        </svg>
                                        Export JSON
                                    </button>
                                    <button class="dropdown-item" id="emailButton">
                                        <svg class="icon" viewBox="0 0 24 24" width="16" height="16">
                                            <path fill="currentColor" d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"></path>
                                        </svg>
                                        Send via Email
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Results UI container -->
                        <div id="dashboardResultsUI"></div>
                        <h1>My VALID Results</h1>
                        <p style="color: #6b7280; margin-bottom: 2rem;">Your decision-making profile and insights from the VALID assessment.</p>
                        
                        <!-- Assessment Status -->
                        <div class="dashboard-card" id="assessmentStatusCard">
                            <div class="card-header">
                                <h3 class="card-title">Assessment Status</h3>
                            </div>
                            <div class="card-content">
                                <div id="noAssessmentMessage" style="display: none;">
                                    <div style="text-align: center; padding: 2rem;">
                                        <i class="fas fa-clipboard-list" style="font-size: 3rem; color: #6b7280; margin-bottom: 1rem;"></i>
                                        <h3 style="color: #374151; margin-bottom: 0.5rem;">No Assessment Completed</h3>
                                        <p style="color: #6b7280; margin-bottom: 1.5rem;">You haven't completed the VALID assessment yet. Take the assessment to see your personalized results.</p>
                                        <button class="btn primary" onclick="showSection('overviewSection')">
                                            <i class="fas fa-play"></i>
                                            Start VALID Assessment
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="incompleteAssessmentMessage" style="display: none;">
                                    <div style="text-align: center; padding: 2rem;">
                                        <i class="fas fa-pause-circle" style="font-size: 3rem; color: #f59e0b; margin-bottom: 1rem;"></i>
                                        <h3 style="color: #374151; margin-bottom: 0.5rem;">Assessment In Progress</h3>
                                        <p style="color: #6b7280; margin-bottom: 1rem;">You have an incomplete assessment. Continue where you left off to see your results.</p>
                                        
                                        <!-- Progress Bar -->
                                        <div style="margin: 1.5rem 0;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                                <span style="font-size: 0.875rem; color: #6b7280;">Progress</span>
                                                <span style="font-size: 0.875rem; color: #6b7280;" id="progressPercentage">0%</span>
                                            </div>
                                            <div style="background: #e5e7eb; border-radius: 8px; height: 8px; overflow: hidden;">
                                                <div id="progressBar" style="background: linear-gradient(90deg, #f59e0b, #f97316); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                            </div>
                                            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                                                <span id="questionsCompleted">0</span> of <span id="totalQuestions">25</span> questions completed
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                            <button class="btn primary" onclick="resumeAssessment()">
                                                <i class="fas fa-play"></i>
                                                Resume Assessment
                                            </button>
                                            <button class="btn secondary" onclick="startNewAssessment()">
                                                <i class="fas fa-plus"></i>
                                                Start New
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="assessmentResults" style="display: none;">
                                    <!-- Results will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Valid360 Section -->
                    <div id="valid360Section" class="dashboard-section" style="display: none;">
                        <h1>Valid360 Assessment</h1>
                        <p style="color: #6b7280; margin-bottom: 2rem;">Comprehensive feedback from multiple perspectives.</p>
                        
                        <div class="dashboard-card">
                            <div class="coming-soon">
                                <i class="fas fa-tools"></i>
                                <strong>Under Development</strong><br>
                                Our Valid360 assessment tool is currently being built. 
                                This will allow you to gather feedback from peers, managers, and direct reports 
                                to get a comprehensive view of your performance and development areas.
                            </div>
                        </div>
                    </div>

                    <!-- Team Management Section -->
                    <div id="teamSection" class="dashboard-section" style="display: none;">
                        <div class="team-management-header">
                            <h1>Team Management</h1>
                            <p style="color: #6b7280; margin-bottom: 2rem;">Create teams, manage members, and compare VALID results across your organization and external partners.</p>
                            
                            <div class="team-actions">
                                <button id="createTeamBtn" class="btn primary" onclick="showCreateTeamModal()">
                                    <i class="fas fa-plus"></i> Create New Team
                                </button>
                                <button id="joinTeamBtn" class="btn secondary" onclick="showJoinTeamModal()">
                                    <i class="fas fa-sign-in-alt"></i> Join Team
                                </button>
                                <button id="loadDemoDataBtn" class="btn secondary" onclick="loadTeamDemoData()" style="background: #8b5cf6;" title="Load Demo Data (Ctrl+Shift+L)">
                                    <i class="fas fa-database"></i> Load Demo Data
                                </button>
                                <button id="clearDemoDataBtn" class="btn secondary" onclick="clearTeamDemoData()" style="background: #ef4444; display: none;" title="Clear Demo Data (Ctrl+Shift+C)">
                                    <i class="fas fa-trash"></i> Clear Demo Data
                                </button>
                            </div>
                        </div>

                        <!-- Team Overview -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3 class="card-title">My Teams</h3>
                                <div class="team-filters">
                                    <select id="teamTypeFilter" class="form-control" onchange="filterTeams()">
                                        <option value="">All Teams</option>
                                        <option value="internal">Internal Teams</option>
                                        <option value="external">External Teams</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-content">
                                <div id="teamGrid" class="team-grid">
                                    <!-- Teams will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Team Details Section -->
                        <div id="teamDetailsSection" class="dashboard-card" style="display: none; margin-top: 2rem;">
                            <div class="card-header">
                                <h3 class="card-title" id="currentTeamName">Team Name</h3>
                                <div class="team-detail-actions">
                                    <button id="inviteMemberBtn" class="btn secondary" onclick="showInviteMemberModal()">
                                        <i class="fas fa-user-plus"></i> Invite Member
                                    </button>
                                    <button id="shareResultsBtn" class="btn primary" onclick="shareResultsWithTeam()">
                                        <i class="fas fa-share-alt"></i> Share My Results
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="team-stats-overview">
                                    <div class="stat-item">
                                        <div class="stat-number" id="teamMemberCount">0</div>
                                        <div class="stat-label">Team Members</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number" id="teamAssessmentCount">0</div>
                                        <div class="stat-label">Completed Assessments</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number" id="teamCompletionRate">0%</div>
                                        <div class="stat-label">Completion Rate</div>
                                    </div>
                                </div>
                                
                                <div class="team-members-section">
                                    <h4>Team Members</h4>
                                    <div id="memberGrid" class="member-grid">
                                        <!-- Team members will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Team Comparison Section -->
                        <div class="dashboard-card" style="margin-top: 2rem;">
                            <div class="card-header">
                                <h3 class="card-title">Team Comparison</h3>
                                <button id="createComparisonBtn" class="btn primary" onclick="showCreateComparisonModal()">
                                    <i class="fas fa-chart-line"></i> Create Comparison
                                </button>
                            </div>
                            <div class="card-content">
                                <div id="comparisonSessions" class="comparison-sessions">
                                    <!-- Comparison sessions will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Create Team Modal -->
                    <div id="createTeamModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>Create New Team</h2>
                                <button class="modal-close" onclick="closeModal('createTeamModal')">&times;</button>
                            </div>
                            <form id="createTeamForm" class="modal-form">
                                <div class="form-group">
                                    <label for="teamName">Team Name *</label>
                                    <input type="text" id="teamName" name="teamName" required>
                                </div>
                                <div class="form-group">
                                    <label for="teamDescription">Description</label>
                                    <textarea id="teamDescription" name="teamDescription" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="organizationName">Organization Name</label>
                                    <input type="text" id="organizationName" name="organizationName">
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="isExternal" name="isExternal" value="true">
                                        <span class="checkmark"></span>
                                        This is an external team (outside your organization)
                                    </label>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn secondary" onclick="closeModal('createTeamModal')">Cancel</button>
                                    <button type="submit" class="btn primary">Create Team</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Join Team Modal -->
                    <div id="joinTeamModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>Join Team</h2>
                                <button class="modal-close" onclick="closeModal('joinTeamModal')">&times;</button>
                            </div>
                            <form id="joinTeamForm" class="modal-form">
                                <div class="form-group">
                                    <label for="invitationToken">Invitation Token *</label>
                                    <input type="text" id="invitationToken" name="invitationToken" required 
                                           placeholder="Paste your invitation token here">
                                    <small>Enter the invitation token you received via email</small>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn secondary" onclick="closeModal('joinTeamModal')">Cancel</button>
                                    <button type="submit" class="btn primary">Join Team</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Invite Member Modal -->
                    <div id="inviteMemberModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>Invite Team Member</h2>
                                <button class="modal-close" onclick="closeModal('inviteMemberModal')">&times;</button>
                            </div>
                            <form id="inviteMemberForm" class="modal-form">
                                <div class="form-group">
                                    <label for="inviteEmail">Email Address *</label>
                                    <input type="email" id="inviteEmail" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label for="inviteRole">Role</label>
                                    <select id="inviteRole" name="role">
                                        <option value="member">Member</option>
                                        <option value="manager">Manager</option>
                                        <option value="viewer">Viewer</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="inviteMessage">Personal Message (Optional)</label>
                                    <textarea id="inviteMessage" name="message" rows="3" 
                                              placeholder="Add a personal message to your invitation..."></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn secondary" onclick="closeModal('inviteMemberModal')">Cancel</button>
                                    <button type="submit" class="btn primary">Send Invitation</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Create Comparison Modal -->
                    <div id="createComparisonModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>Create Team Comparison</h2>
                                <button class="modal-close" onclick="closeModal('createComparisonModal')">&times;</button>
                            </div>
                            <form id="createComparisonForm" class="modal-form">
                                <div class="form-group">
                                    <label for="comparisonName">Comparison Name *</label>
                                    <input type="text" id="comparisonName" name="comparisonName" required>
                                </div>
                                <div class="form-group">
                                    <label for="comparisonDescription">Description</label>
                                    <textarea id="comparisonDescription" name="comparisonDescription" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="comparisonTeam">Select Team</label>
                                    <select id="comparisonTeam" name="comparisonTeam" required>
                                        <option value="">Choose a team...</option>
                                    </select>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn secondary" onclick="closeModal('createComparisonModal')">Cancel</button>
                                    <button type="submit" class="btn primary">Create Comparison</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Documents Section -->
                    <div id="documentsSection" class="dashboard-section" style="display: none;">
                        <h1>Upload Documents</h1>
                        <p style="color: #6b7280; margin-bottom: 2rem;">Upload other assessment results to compare with your VALID profile.</p>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3 class="card-title">Upload Assessment Documents</h3>
                            </div>
                            <div class="card-content">
                                <div class="upload-area" id="uploadArea">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #6b7280; margin-bottom: 1rem;"></i>
                                    <h4>Drag & Drop Files Here</h4>
                                    <p style="color: #6b7280; margin-bottom: 1rem;">or</p>
                                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                                        <i class="fas fa-folder-open"></i>
                                        Browse Files
                                    </button>
                                    <input type="file" id="fileInput" style="display: none;" multiple accept=".pdf,.doc,.docx,.txt,.json">
                                    <p style="font-size: 0.875rem; color: #6b7280; margin-top: 1rem;">
                                        Supported formats: PDF, DOC, DOCX, TXT, JSON<br>
                                        Max file size: 10MB per file
                                    </p>
                                </div>
                                
                                <div id="uploadedDocuments">
                                    <h4>Uploaded Documents</h4>
                                    <div id="documentsList">
                                        <div style="color: #6b7280; text-align: center; padding: 1rem;">
                                            No documents uploaded yet.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Section -->
                    <div id="profileSection" class="dashboard-section" style="display: none;">
                        <div class="profile-grid">
                            <!-- Profile Summary Card -->
                            <div class="profile-summary-card">
                                <div class="profile-avatar">
                                    <img id="profileAvatarImg" src="" alt="Profile Avatar" style="display:none;">
                                    <div class="avatar-placeholder" id="profileAvatarPlaceholder">
                                        <i class="fas fa-user"></i>
                                    </div>
                                </div>
                                <div class="profile-info" style="text-align:center;">
                                    <h3 id="profileFullName">Full Name</h3>
                                    <p id="profileEmail" class="profile-email">user@example.com</p>
                                    <p id="profileJobTitle" class="profile-job-title" style="color:#6b7280;font-size:0.98rem;margin-top:0.2rem;">Job Title</p>
                                </div>
                            </div>
                            <!-- Profile Form -->
                            <form id="profileForm" class="profile-form">
                                <h2>My Profile</h2>
                                <p class="profile-form-desc">Manage your personal information, demographics, and account settings.</p>
                                
                                <!-- Profile Picture Section -->
                                <div class="profile-picture-section">
                                    <label>Profile Picture</label>
                                    <div class="profile-picture-container">
                                        <div class="profile-picture-preview">
                                            <img id="profilePicturePreview" src="" alt="Profile Picture" style="display: none;">
                                            <div id="profilePictureInitials" class="profile-picture-initials">
                                                <span id="profileInitialsText">JD</span>
                                            </div>
                                        </div>
                                        <div class="profile-picture-actions">
                                            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                                            <button type="button" id="uploadPictureBtn" class="btn-upload-picture">
                                                <i class="fas fa-camera"></i>
                                                Upload Photo
                                            </button>
                                            <button type="button" id="removePictureBtn" class="btn-remove-picture" style="display: none;">
                                                <i class="fas fa-trash"></i>
                                                Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="first_name">First Name</label>
                                        <input type="text" name="first_name" id="first_name" autocomplete="given-name">
                                    </div>
                                    <div class="form-group">
                                        <label for="last_name">Last Name</label>
                                        <input type="text" name="last_name" id="last_name" autocomplete="family-name">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="email">Email Address</label>
                                        <input type="email" name="email" id="email" autocomplete="email">
                                    </div>
                                    <div class="form-group">
                                        <label for="role">Job Title</label>
                                        <input type="text" name="role" id="role">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="department">Department</label>
                                        <select name="department" id="department">
                                            <option value="">Please select...</option>
                                            <option value="Executive">Executive</option>
                                            <option value="Finance">Finance</option>
                                            <option value="HR">Human Resources</option>
                                            <option value="IT">Information Technology</option>
                                            <option value="Marketing">Marketing</option>
                                            <option value="Operations">Operations</option>
                                            <option value="Sales">Sales</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="role_level">Role Level</label>
                                        <select name="role_level" id="role_level">
                                            <option value="">Please select...</option>
                                            <option value="Individual Contributor">Individual Contributor</option>
                                            <option value="Team Lead">Team Lead</option>
                                            <option value="Manager">Manager</option>
                                            <option value="Director">Director</option>
                                            <option value="VP/C-Suite">VP/C-Suite</option>
                                            <option value="Owner/Founder">Owner/Founder</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="experience">Years of Experience</label>
                                        <select name="experience" id="experience">
                                            <option value="">Please select...</option>
                                            <option value="0-2">0-2 years</option>
                                            <option value="3-5">3-5 years</option>
                                            <option value="6-10">6-10 years</option>
                                            <option value="11-15">11-15 years</option>
                                            <option value="15+">15+ years</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="organization">Organization</label>
                                        <input type="text" name="organization" id="organization">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="phone">Phone</label>
                                        <input type="text" name="phone" id="phone">
                                    </div>
                                    <div class="form-group">
                                        <label for="bio">Bio</label>
                                        <textarea name="bio" id="bio" rows="2"></textarea>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" id="saveProfileBtn" class="btn-save">Save Changes</button>
                                    <button type="button" id="cancelProfileBtn" class="btn-cancel">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- My Decisions Section (Mockup) -->
                    <div id="myDecisionsSection" class="dashboard-section" style="display: none;">
                        <div class="decisions-header">
                            <h1>My Decisions</h1>
                            <button class="btn primary" onclick="showDecisionForm()">
                                <i class="fas fa-magic"></i> Analyze New Decision
                            </button>
                        </div>
                        <!-- Decision Submission Panel -->
                        <div id="decisionFormPanel" class="dashboard-card" style="margin-bottom: 2rem; display: none;">
                            <form id="decisionForm">
                                <h2>Analyze a New Decision</h2>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="decisionTitle">Decision Title</label>
                                        <input type="text" id="decisionTitle" name="decisionTitle" placeholder="e.g. Q2 Product Launch Strategy" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="decisionContext">Description / Context</label>
                                        <textarea id="decisionContext" name="decisionContext" rows="2" placeholder="Describe the decision, context, and stakes..." required></textarea>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="decisionTeam">Select Team(s)</label>
                                        <select id="decisionTeam" name="decisionTeam" multiple>
                                            <option>Marketing Team</option>
                                            <option>Product Development</option>
                                            <option>External Partners</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="decisionFiles">Upload Supporting Data</label>
                                        <input type="file" id="decisionFiles" name="decisionFiles" multiple>
                                        <small>Psychometric, market, or other reports (PDF, CSV, XLSX)</small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Include External Factors</label>
                                        <div class="external-factors">
                                            <label><input type="checkbox" name="factor" value="market" checked> Market</label>
                                            <label><input type="checkbox" name="factor" value="geo"> Geo-political</label>
                                            <label><input type="checkbox" name="factor" value="finance"> Finance</label>
                                            <label><input type="checkbox" name="factor" value="weather"> Weather</label>
                                            <label><input type="checkbox" name="factor" value="location"> Location</label>
                                            <label><input type="checkbox" name="factor" value="trending"> Trending</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn secondary" onclick="hideDecisionForm()">Cancel</button>
                                    <button type="submit" class="btn primary">Analyze Decision</button>
                                </div>
                            </form>
                        </div>
                        <!-- Analysis Results Panel (Mockup) -->
                        <div id="decisionResultsPanel" class="dashboard-card" style="display: block;">
                            <div class="decision-summary-header">
                                <div>
                                    <h2>Q2 Product Launch Strategy</h2>
                                    <div class="decision-meta">Strategic Decision â€¢ High Stakes â€¢ 5 Team Members â€¢ Due: March 15</div>
                                </div>
                                <div class="ai-suggestion">
                                    <i class="fas fa-robot"></i> <span>AI Suggests: <strong>Delay 2 weeks</strong> â€“ Market conditions sub-optimal</span>
                                </div>
                            </div>
                            <div class="decision-mockup-grid">
                                <!-- Team Validation Profile -->
                                <div class="decision-col team-validation-profile">
                                    <h4>Team Validation Profile</h4>
                                    <div class="team-validation-list">
                                        <div class="team-member-profile">
                                            <span class="avatar avatar-blue">AS</span>
                                            <div>
                                                <strong>Alex Smith</strong><br>
                                                <span class="profile-role">Verity Leader â€¢ Data-Driven</span>
                                                <div class="validation-bars">
                                                    <span class="bar verity"></span>
                                                    <span class="bar association"></span>
                                                    <span class="bar lived"></span>
                                                    <span class="bar institutional"></span>
                                                    <span class="bar desire"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="team-member-profile">
                                            <span class="avatar avatar-green">JD</span>
                                            <div>
                                                <strong>Jordan Davis</strong><br>
                                                <span class="profile-role">Association Builder â€¢ Collaborative</span>
                                                <div class="validation-bars">
                                                    <span class="bar verity"></span>
                                                    <span class="bar association"></span>
                                                    <span class="bar lived"></span>
                                                    <span class="bar institutional"></span>
                                                    <span class="bar desire"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="team-member-profile">
                                            <span class="avatar avatar-teal">MJ</span>
                                            <div>
                                                <strong>Morgan Johnson</strong><br>
                                                <span class="profile-role">Experience Navigator â€¢ Intuitive</span>
                                                <div class="validation-bars">
                                                    <span class="bar verity"></span>
                                                    <span class="bar association"></span>
                                                    <span class="bar lived"></span>
                                                    <span class="bar institutional"></span>
                                                    <span class="bar desire"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="team-member-profile">
                                            <span class="avatar avatar-orange">RW</span>
                                            <div>
                                                <strong>Riley Wilson</strong><br>
                                                <span class="profile-role">Process Expert â€¢ Methodical</span>
                                                <div class="validation-bars">
                                                    <span class="bar verity"></span>
                                                    <span class="bar association"></span>
                                                    <span class="bar lived"></span>
                                                    <span class="bar institutional"></span>
                                                    <span class="bar desire"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="team-member-profile">
                                            <span class="avatar avatar-red">TC</span>
                                            <div>
                                                <strong>Taylor Chen</strong><br>
                                                <span class="profile-role">Vision Driver â€¢ Values-Based</span>
                                                <div class="validation-bars">
                                                    <span class="bar verity"></span>
                                                    <span class="bar association"></span>
                                                    <span class="bar lived"></span>
                                                    <span class="bar institutional"></span>
                                                    <span class="bar desire"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="validation-gap-alert">
                                        <i class="fas fa-exclamation-triangle"></i> <strong>Bias Alert: Groupthink Risk</strong><br>
                                        Team lacks Desire validation diversity. Consider external perspective.
                                    </div>
                                </div>
                                <!-- Environmental Context -->
                                <div class="decision-col env-context">
                                    <h4>Environmental Context</h4>
                                    <div class="env-factor high-volatility">Market Sentiment <span class="factor-value bearish">Bearish â†“ -15%</span></div>
                                    <div class="env-factor">Tech Sector VIX <span class="factor-value high">High â†‘ 31.2</span></div>
                                    <div class="env-factor">Consumer Confidence <span class="factor-value declining">Declining â†“ -8%</span></div>
                                    <div class="env-factor">Regulatory Environment <span class="factor-value stable">Stable â†’ No changes</span></div>
                                    <div class="env-factor">Competitor Activity <span class="factor-value high">High â†‘ 3 launches</span></div>
                                    <div class="env-factor">Supply Chain <span class="factor-value disrupted">Disrupted â†“ 2 week delay</span></div>
                                    <div class="env-factor-tags">
                                        <span class="env-tag">Bloomberg API</span>
                                        <span class="env-tag">Fed Economic Data</span>
                                        <span class="env-tag">News Sentiment</span>
                                        <span class="env-tag">Weather API</span>
                                        <span class="env-tag">Industry Reports</span>
                                    </div>
                                </div>
                                <!-- AI Decision Guidance -->
                                <div class="decision-col ai-guidance">
                                    <h4>AI Decision Guidance <span class="review-recommended">Review Recommended</span></h4>
                                    <div class="ai-guidance-list">
                                        <div class="ai-guidance-item high-priority">
                                            <strong>High Priority:</strong> Delay launch 2 weeks due to market volatility and supply chain disruption
                                        </div>
                                        <div class="ai-guidance-item team-optimization">
                                            <strong>Team Optimization:</strong> Include external advisor to counter groupthink bias in current team composition
                                        </div>
                                        <div class="ai-guidance-item validation-strategy">
                                            <strong>Validation Strategy:</strong> Prioritize Verity validation: Run customer pilot before full launch
                                        </div>
                                        <div class="ai-guidance-item risk-mitigation">
                                            <strong>Risk Mitigation:</strong> Prepare 3 contingency plans given high environmental uncertainty
                                        </div>
                                    </div>
                                    <div class="ai-guidance-steps">
                                        <button class="btn step-btn context">Context</button>
                                        <button class="btn step-btn validate">Validate</button>
                                        <button class="btn step-btn decide">Decide</button>
                                        <button class="btn step-btn execute">Execute</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Lower Panels -->
                            <div class="decision-mockup-lower-grid">
                                <div class="decision-col optimal-strategy">
                                    <h4>Optimal Validation Strategy <span class="ai-optimized">AI Optimized</span></h4>
                                    <div class="validation-strategy-chart">
                                        <span class="chart-placeholder">[Validation Strategy Effectiveness Chart]</span>
                                    </div>
                                    <div class="recommended-sequence">
                                        <strong>Recommended Sequence:</strong>
                                        <ol>
                                            <li>Verity: Customer pilot (Alex leads)</li>
                                            <li>Association: Industry benchmark (Jordan)</li>
                                            <li>Institutional: Expert review (Riley)</li>
                                            <li>Lived Experience: Past launch analysis (Morgan)</li>
                                            <li>Desire: Vision alignment (Taylor)</li>
                                        </ol>
                                    </div>
                                    <div class="risk-factors">
                                        <strong>Risk Factors:</strong>
                                        <ul>
                                            <li>Market timing uncertainty</li>
                                            <li>Supply chain volatility</li>
                                            <li>Team groupthink tendency</li>
                                            <li>Limited external input</li>
                                            <li>High competitive pressure</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="decision-col decision-feed">
                                    <h4>Decision Intelligence Feed <span class="live-updates">Live Updates</span></h4>
                                    <div class="decision-feed-list">
                                        <div class="feed-item">
                                            <span class="feed-time">15 min ago â€¢ Market Data</span>
                                            Tech stock volatility increased 12% â€“ consider launch delay
                                        </div>
                                        <div class="feed-item">
                                            <span class="feed-time">1 hour ago â€¢ Team Analysis</span>
                                            Jordan added 3 new stakeholder perspectives â€“ bias risk reduced
                                        </div>
                                        <div class="feed-item">
                                            <span class="feed-time">2 hours ago â€¢ Industry Intel</span>
                                            Competitor announced similar product launch for April â€“ strategic implications
                                        </div>
                                        <div class="feed-item">
                                            <span class="feed-time">4 hours ago â€¢ Risk Alert</span>
                                            Supply chain partner reported disruption â€“ 2 week delay
                                        </div>
                                    </div>
                                    <div class="next-action-box">
                                        <i class="fas fa-bolt"></i> <strong>Next Recommended Action</strong><br>
                                        Schedule team validation session with external advisor within 24 hours
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Assessment Scripts -->
    <script src="js/assessment-state-manager.js"></script>
    
    <!-- Initialize Assessment State Manager -->
    <script>
        // Initialize assessment state manager immediately after loading
        if (typeof AssessmentStateManager !== 'undefined') {
            window.assessmentStateManager = new AssessmentStateManager();
            console.log('âœ… Assessment State Manager initialized successfully');
        } else {
            console.error('âŒ AssessmentStateManager class not found');
        }
    </script>
    
    <script type="module" src="js/app.js?v=2024-01-15-v3"></script>
    <script type="module" src="js/assessment-controller.js?v=2024-01-15-v4"></script>
    <script type="module" src="js/event-handlers.js?v=2024-01-15-v3"></script>
    <script type="module" src="js/assessment-manager.js"></script>
    <script type="module" src="js/results-ui.js"></script>
    
    <!-- Development and Utility Scripts -->
    <script src="js/dev-env.js"></script>
    <script type="module" src="js/logger.js"></script>
    <script type="module" src="js/utils.js?v=2024-01-15-v3"></script>
    <script type="module" src="js/state-manager.js?v=2024-01-15-v3"></script>
    <script type="module" src="js/scoring.js?v=2024-01-15-v3"></script>
    <script type="module" src="js/supabase-client.js"></script>
    <script type="module" src="js/database-clean.js"></script>
    <script type="module" src="js/session-manager.js"></script>
    <script type="module" src="js/validation.js"></script>
    <script type="module" src="js/reports.js"></script>
    <script type="module" src="js/questions-data.js"></script>
    <script type="module" src="js/dev-helpers.js"></script>
    <script type="module" src="js/version-manager.js?v=2024-01-15-v3"></script>
    <script type="module" src="js/main.js?v=2024-01-15-v3"></script>
    
    <!-- Gamification Scripts -->
    <script type="module" src="js/gamification.js"></script>
    <script type="module" src="js/gamification-questions.js"></script>

    <!-- Team Management Scripts -->
    <script type="module" src="js/team-management.js"></script>

    <script>
        console.log("DASHBOARD SCRIPT LOADED - Starting initialization...");
        
        // Dashboard functionality
        let currentUser = null;
        let dashboardData = {
            assessments: [],
            reports: [],
            teamMembers: []
        };

        // Team Management Global Functions
        window.showCreateTeamModal = function() {
            document.getElementById('createTeamModal').style.display = 'block';
        };

        window.showJoinTeamModal = function() {
            document.getElementById('joinTeamModal').style.display = 'block';
        };

        window.showInviteMemberModal = function() {
            document.getElementById('inviteMemberModal').style.display = 'block';
        };

        window.showCreateComparisonModal = function() {
            document.getElementById('createComparisonModal').style.display = 'block';
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        window.filterTeams = function() {
            const filter = document.getElementById('teamTypeFilter').value;
            const teamCards = document.querySelectorAll('.team-card');
            
            teamCards.forEach(card => {
                if (!filter || 
                    (filter === 'internal' && !card.classList.contains('external-team')) ||
                    (filter === 'external' && card.classList.contains('external-team'))) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        };

        window.shareResultsWithTeam = async function() {
            try {
                if (window.teamManagement && window.teamManagement.currentTeam) {
                    await window.teamManagement.shareResults(window.teamManagement.currentTeam.id);
                    showTeamMessage('Results shared successfully!', 'success');
                } else {
                    showTeamMessage('No team selected', 'error');
                }
            } catch (error) {
                console.error('Error sharing results:', error);
                showTeamMessage('Error sharing results', 'error');
            }
        };

        function showTeamMessage(message, type) {
            const teamSection = document.getElementById('teamSection');
            if (!teamSection) return;

            // Remove existing messages
            const existingMessage = teamSection.querySelector('.team-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `team-message ${type}`;
            messageDiv.textContent = message;

            // Insert at the top of the team section
            const firstChild = teamSection.firstElementChild;
            teamSection.insertBefore(messageDiv, firstChild);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Initialize team management when section is shown
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize team management
            try {
                // Wait for team management module to load
                await new Promise(resolve => {
                    const checkTeamManagement = () => {
                        if (window.teamManagement) {
                            resolve();
                        } else {
                            setTimeout(checkTeamManagement, 100);
                        }
                    };
                    checkTeamManagement();
                });

                await window.teamManagement.initialize();
                console.log('âœ… Team Management initialized');
                
                // Make team management globally available
                window.teamManagement = window.teamManagement;
                
            } catch (error) {
                console.error('âŒ Failed to initialize Team Management:', error);
                // Create a fallback team management object
                window.teamManagement = {
                    userTeams: [],
                    isDemoMode: true,
                    renderTeams: function() {
                        const teamGrid = document.getElementById('teamGrid');
                        if (teamGrid) {
                            teamGrid.innerHTML = `
                                <div class="team-empty-state">
                                    <i class="fas fa-users"></i>
                                    <h3>Team Management Loading...</h3>
                                    <p>Please refresh the page if this persists.</p>
                                </div>
                            `;
                        }
                    },
                    selectTeam: function(teamId) {
                        console.log('Team selected:', teamId);
                    }
                };
            }

            // Add event listeners for team forms
            const createTeamForm = document.getElementById('createTeamForm');
            const joinTeamForm = document.getElementById('joinTeamForm');
            const inviteMemberForm = document.getElementById('inviteMemberForm');
            const createComparisonForm = document.getElementById('createComparisonForm');

            if (createTeamForm) {
                createTeamForm.addEventListener('submit', handleCreateTeam);
            }

            if (joinTeamForm) {
                joinTeamForm.addEventListener('submit', handleJoinTeam);
            }

            if (inviteMemberForm) {
                inviteMemberForm.addEventListener('submit', handleInviteMember);
            }

            if (createComparisonForm) {
                createComparisonForm.addEventListener('submit', handleCreateComparison);
            }

            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });

            // Add keyboard shortcuts for demo management
            document.addEventListener('keydown', function(event) {
                // Ctrl/Cmd + Shift + L to load demo data
                if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'L') {
                    event.preventDefault();
                    if (document.getElementById('loadDemoDataBtn') && !document.getElementById('loadDemoDataBtn').disabled) {
                        loadTeamDemoData();
                    }
                }
                
                // Ctrl/Cmd + Shift + C to clear demo data
                if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'C') {
                    event.preventDefault();
                    if (document.getElementById('clearDemoDataBtn') && document.getElementById('clearDemoDataBtn').style.display !== 'none') {
                        clearTeamDemoData();
                    }
                }
            });
        });

        async function handleCreateTeam(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const teamData = {
                    name: formData.get('teamName'),
                    description: formData.get('teamDescription'),
                    organization_name: formData.get('organizationName'),
                    is_external: formData.get('isExternal') === 'true'
                };

                if (window.teamManagement) {
                    await window.teamManagement.createTeam(teamData);
                    window.teamManagement.renderTeams();
                    showTeamMessage('Team created successfully!', 'success');
                }
                
                closeModal('createTeamModal');
                event.target.reset();
                
            } catch (error) {
                console.error('Error creating team:', error);
                showTeamMessage('Error creating team', 'error');
            }
        }

        async function handleJoinTeam(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const token = formData.get('invitationToken');

                if (window.teamManagement) {
                    const result = await window.teamManagement.acceptInvitation(token);
                    if (result.success) {
                        showTeamMessage('Successfully joined team!', 'success');
                        window.teamManagement.renderTeams();
                    } else {
                        showTeamMessage(result.message || 'Invalid invitation token', 'error');
                    }
                }
                
                closeModal('joinTeamModal');
                event.target.reset();
                
            } catch (error) {
                console.error('Error joining team:', error);
                showTeamMessage('Error joining team', 'error');
            }
        }

        async function handleInviteMember(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const inviteData = {
                    email: formData.get('email'),
                    role: formData.get('role'),
                    message: formData.get('message')
                };

                if (window.teamManagement && window.teamManagement.currentTeam) {
                    await window.teamManagement.inviteUserToTeam(
                        window.teamManagement.currentTeam.id,
                        inviteData.email,
                        inviteData.role,
                        inviteData.message
                    );
                    showTeamMessage('Invitation sent successfully!', 'success');
                }
                
                closeModal('inviteMemberModal');
                event.target.reset();
                
            } catch (error) {
                console.error('Error inviting member:', error);
                showTeamMessage('Error sending invitation', 'error');
            }
        }

        async function handleCreateComparison(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const comparisonData = {
                    name: formData.get('comparisonName'),
                    description: formData.get('comparisonDescription'),
                    team_id: formData.get('comparisonTeam')
                };

                if (window.teamManagement) {
                    await window.teamManagement.createComparisonSession(
                        comparisonData.team_id,
                        comparisonData.name,
                        comparisonData.description
                    );
                    showTeamMessage('Comparison session created!', 'success');
                }
                
                closeModal('createComparisonModal');
                event.target.reset();
                
            } catch (error) {
                console.error('Error creating comparison:', error);
                showTeamMessage('Error creating comparison session', 'error');
            }
        }

        // Load assessment results for the current user
        async function loadAssessmentResults() {
            console.log('=== loadAssessmentResults called ===');
            
            try {
                // Check if assessmentStateManager is available
                if (!window.assessmentStateManager) {
                    console.error('âŒ assessmentStateManager is not available');
                    console.log('ðŸ”„ Rendering empty results UI as fallback');
                    renderDashboardResultsUI();
                    return;
                }

                const currentUser = window.assessmentStateManager.getCurrentUserId();
                console.log('ðŸ‘¤ Current user ID:', currentUser);
                
                if (!currentUser) {
                    console.error('âŒ No current user ID found');
                    console.log('ðŸ”„ Rendering empty results UI as fallback');
                    renderDashboardResultsUI();
                    return;
                }

                // Try to get results from localStorage first
                const localStorageKey = `assessment_results_${currentUser}`;
                const storedResults = localStorage.getItem(localStorageKey);
                
                if (storedResults) {
                    console.log('ðŸ“Š Found results in localStorage');
                    const results = JSON.parse(storedResults);
                    console.log('ðŸ“Š Parsed results:', results);
                    renderDashboardResultsUI(results);
                    return;
                }

                // If no localStorage results, try to get from assessment state manager
                console.log('ðŸ” No localStorage results, checking assessment state manager...');
                const assessmentResults = window.assessmentStateManager.getAssessmentResults();
                
                if (assessmentResults) {
                    console.log('ðŸ“Š Found results in assessment state manager:', assessmentResults);
                    renderDashboardResultsUI(assessmentResults);
                    return;
                }

                // If no results found anywhere, render empty UI
                console.log('ðŸ“Š No results found, rendering empty UI');
                renderDashboardResultsUI();

            } catch (error) {
                console.error('âŒ Error loading assessment results:', error);
                console.log('ðŸ”„ Rendering empty results UI as fallback');
                renderDashboardResultsUI();
            }
        }

        // Render the dashboard results UI
        function renderDashboardResultsUI(results = null) {
            const resultsSection = document.getElementById('dashboardResultsSection');
            if (!resultsSection) return;

            // If no results, show empty state
            if (!results) {
                resultsSection.innerHTML = `
                    <div class="my-results-section">
                        <h1>Your VALID Assessment Results</h1>
                        <p class="description">This analysis provides insights into your decision-making style and preferences across the five VALID dimensions.</p>
                        <div class="alert" style="background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                            <strong>No Results Available:</strong> Complete the VALID assessment to see your personalized results.
                        </div>
                    </div>
                `;
                return;
            }

            // Extract scores from results
            const scores = results.scores || {};
            const awareness = results.awareness || { percent: 0 };
            
            // Map dimension names
            const dimensionNames = {
                'V': 'Verity (Data-Driven)',
                'A': 'Association (Relationship)',
                'L': 'Lived Experience',
                'I': 'Institutional Knowledge',
                'D': 'Desire (Future-Focused)'
            };

            // Get primary and secondary styles
            const sortedScores = Object.entries(scores).sort(([,a], [,b]) => b - a);
            const primaryStyle = sortedScores[0] || ['V', 0];
            const secondaryStyle = sortedScores[1] || ['A', 0];

            // Get primary and secondary descriptions
            const styleDescriptions = {
                'V': 'You excel in data-driven decision making and analytical problem-solving. This systematic approach enables you to make well-researched and objective decisions.',
                'A': 'You excel in relationship-based decision making and collaborative problem-solving. This interpersonal approach enables you to make decisions that consider multiple perspectives.',
                'L': 'You excel in experience-based decision making and practical problem-solving. This hands-on approach enables you to make decisions based on real-world knowledge.',
                'I': 'You excel in knowledge-based decision making and systematic problem-solving. This structured approach enables you to make decisions based on established frameworks.',
                'D': 'You excel in future-focused decision making and visionary problem-solving. This forward-thinking approach enables you to make decisions that align with long-term goals.'
            };

            const styleCautions = {
                'V': 'High reliance on data can sometimes lead to analysis paralysis or overlook human factors.',
                'A': 'High association-based validation may lead to groupthink or difficulty making independent decisions.',
                'L': 'Over-reliance on past experience may limit innovation or adaptation to new situations.',
                'I': 'Strict adherence to institutional knowledge may resist change or miss emerging opportunities.',
                'D': 'Future-focused thinking may overlook immediate practical concerns or current constraints.'
            };

            // Scenario options for the dropdown
            const scenarioOptions = [
                { value: 'general', label: 'ðŸŽ¯ General Decision Making' },
                { value: 'work', label: 'ðŸ’¼ Work & Professional' },
                { value: 'leadership', label: 'ðŸ‘¥ Leadership & Management' },
                { value: 'personal', label: 'ðŸ  Personal & Life' },
                { value: 'crisis', label: 'âš¡ Crisis & High Pressure' },
                { value: 'innovation', label: 'ðŸš€ Innovation & Change' },
                { value: 'collaboration', label: 'ðŸ¤ Collaboration & Teamwork' },
                { value: 'strategic', label: 'ðŸ“Š Strategic Planning' }
            ];
            const selectedScenario = results.currentScenario || 'general';
            const dropdownHtml = `
                <select class="scenario-dropdown" id="scenarioDropdown" onchange="changeScenario(this.value)">
                    ${scenarioOptions.map(opt =>
                        `<option value="${opt.value}"${opt.value === selectedScenario ? ' selected' : ''}>${opt.label}</option>`
                    ).join('')}
                </select>
            `;

            resultsSection.innerHTML = `
                <div class="my-results-section">
                    <h1>Your VALID Assessment Results</h1>
                    <p class="description">This analysis provides insights into your decision-making style and preferences across the five VALID dimensions.</p>
                    <div class="alert"><strong>Real Data:</strong> Your assessment results based on your actual responses.<br><span style="font-weight:400;">Based on ${results.questionsAnswered || 25} question responses.</span></div>
                    <div class="scenario-selector">
                        <div class="scenario-header">
                            <h3>View Results in Different Contexts</h3>
                            <p>Select a scenario to see how your decision-making style applies in specific situations:</p>
                        </div>
                        <div class="scenario-controls">
                            ${dropdownHtml}
                            <div class="scenario-info">
                                <span id="scenarioDescription">${scenarioDescriptions[selectedScenario] || scenarioDescriptions.general}</span>
                            </div>
                        </div>
                    </div>
                    <div class="profile-section">
                        <div class="chart-section">
                            <h2>Decision-Making Profile</h2>
                            <div class="chart-container">
                                <canvas id="radarChart"></canvas>
                            </div>
                            <div class="awareness-section">
                                <h3>Metacognitive Awareness</h3>
                                <div class="awareness-score">
                                    <div class="score-label">
                                        <span>Self-Reflection & Decision Awareness</span>
                                        <span class="score-value">${awareness.percent || 0}%</span>
                                    </div>
                                    <div class="score-bar awareness" style="width: ${awareness.percent || 0}%"></div>
                                    <p class="awareness-description">Your ability to reflect on and understand your own decision-making processes.</p>
                                </div>
                            </div>
                        </div>
                        <div class="scores-section">
                            <div class="primary-style">
                                <h3>Primary Style: <span class="primary-style-name ${primaryStyle[0].toLowerCase()}-color">${dimensionNames[primaryStyle[0]]}</span> <span class="primary-style-score ${primaryStyle[0].toLowerCase()}-color">${primaryStyle[1]}%</span></h3>
                                <p>${styleDescriptions[primaryStyle[0]]}</p>
                                <p class="caution-text">${styleCautions[primaryStyle[0]]}</p>
                            </div>
                            <div class="secondary-style">
                                <h3>Secondary Style: <span class="secondary-style-name ${secondaryStyle[0].toLowerCase()}-color">${dimensionNames[secondaryStyle[0]]}</span> <span class="secondary-style-score ${secondaryStyle[0].toLowerCase()}-color">${secondaryStyle[1]}%</span></h3>
                                <p>${styleDescriptions[secondaryStyle[0]]}</p>
                                <p class="caution-text">${styleCautions[secondaryStyle[0]]}</p>
                            </div>
                            <div class="dimension-scores">
                                <h3>Dimension Scores</h3>
                                <div class="score-bars">
                                    <div class="score-item">
                                        <div class="score-label"><span>Verity (Data-Driven)</span><span class="score-value">${scores.V || 0}%</span></div>
                                        <div class="score-bar verity" style="width: ${scores.V || 0}%"></div>
                                    </div>
                                    <div class="score-item">
                                        <div class="score-label"><span>Association (Relationship)</span><span class="score-value">${scores.A || 0}%</span></div>
                                        <div class="score-bar association" style="width: ${scores.A || 0}%"></div>
                                    </div>
                                    <div class="score-item">
                                        <div class="score-label"><span>Lived Experience</span><span class="score-value">${scores.L || 0}%</span></div>
                                        <div class="score-bar lived" style="width: ${scores.L || 0}%"></div>
                                    </div>
                                    <div class="score-item">
                                        <div class="score-label"><span>Institutional Knowledge</span><span class="score-value">${scores.I || 0}%</span></div>
                                        <div class="score-bar institutional" style="width: ${scores.I || 0}%"></div>
                                    </div>
                                    <div class="score-item">
                                        <div class="score-label"><span>Desire (Future-Focused)</span><span class="score-value">${scores.D || 0}%</span></div>
                                        <div class="score-bar desire" style="width: ${scores.D || 0}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="general-profile">
                        <div class="general-profile-card verity">
                            <div class="card-title">Verity</div>
                            <div class="card-desc">Strong data-driven decision making</div>
                            <div class="card-score verity-color">${scores.V || 0}%</div>
                        </div>
                        <div class="general-profile-card association">
                            <div class="card-title">Association</div>
                            <div class="card-desc">Relationship building approaches</div>
                            <div class="card-score association-color">${scores.A || 0}%</div>
                        </div>
                        <div class="general-profile-card lived">
                            <div class="card-title">Lived Experience</div>
                            <div class="card-desc">Personal experience integration</div>
                            <div class="card-score lived-color">${scores.L || 0}%</div>
                        </div>
                        <div class="general-profile-card institutional">
                            <div class="card-title">Institutional</div>
                            <div class="card-desc">Organizational knowledge</div>
                            <div class="card-score institutional-color">${scores.I || 0}%</div>
                        </div>
                        <div class="general-profile-card desire">
                            <div class="card-title">Desire</div>
                            <div class="card-desc">Future-focused planning</div>
                            <div class="card-score desire-color">${scores.D || 0}%</div>
                        </div>
                    </div>
                    <div class="validation-insights">
                        <div class="insight-card">
                            <h3>Enhance Data-Driven Decision Making</h3>
                            <p>Focus on incorporating more analytical approaches and evidence-based methods in your decision-making process.</p>
                        </div>
                        <div class="insight-card">
                            <h3>Strengthen Relationship Building</h3>
                            <p>Consider incorporating more collaborative approaches and seeking diverse perspectives in your decision-making process.</p>
                        </div>
                        <div class="insight-card">
                            <h3>Leverage Personal Experience</h3>
                            <p>Look for opportunities to apply your practical experiences more actively in problem-solving situations.</p>
                        </div>
                    </div>
                </div>
            `;

            // Initialize radar chart after DOM is updated
            setTimeout(() => {
                initializeRadarChart(scores);
            }, 100);
        }

        // Initialize radar chart
        function initializeRadarChart(scores) {
            const ctx = document.getElementById('radarChart');
            if (!ctx) {
                console.error('Radar chart canvas not found');
                return;
            }

            // Destroy existing chart if it exists
            if (window.radarChart) {
                window.radarChart.destroy();
            }

            const data = {
                labels: ['Verity', 'Association', 'Lived Experience', 'Institutional', 'Desire'],
                datasets: [{
                    label: 'Your Scores',
                    data: [
                        scores.V || 0,
                        scores.A || 0,
                        scores.L || 0,
                        scores.I || 0,
                        scores.D || 0
                    ],
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                }]
            };

            const config = {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            };

            window.radarChart = new Chart(ctx, config);
        }

        // Test function to create sample results
        function createTestResults() {
            console.log('Create Test Results button clicked!');
            
            // Check if assessmentStateManager is available
            if (!window.assessmentStateManager) {
                console.error('âŒ assessmentStateManager is not available');
                alert('Assessment State Manager is not initialized. Please refresh the page and try again.');
                return;
            }
            
            // Get the current user ID from the assessment state manager
            const userId = window.assessmentStateManager.getCurrentUserId();
            console.log('Current user ID:', userId);
            
            if (!userId) {
                console.error('âŒ No user ID available');
                alert('No user ID found. Please refresh the page and try again.');
                return;
            }

            // Create sample results data with VALID dimensions
            const testResults = {
                id: 'test-assessment-' + Date.now(),
                userId: userId,
                totalScore: 85,
                completionDate: new Date().toLocaleDateString(),
                questionsAnswered: 25,
                scores: {
                    'V': 78,  // Verity
                    'A': 82,  // Association
                    'L': 75,  // Lived Experience
                    'I': 88,  // Institutional
                    'D': 80   // Desire
                },
                awareness: {
                    percent: 72,
                    flag: false
                },
                // Add sample answers for context scoring
                answers: {
                    'DT-01': 6, 'DT-02': 4, 'DT-03': 5, 'DT-04': 6, 'DT-05': 3,
                    'DT-06': 3, 'DT-07': 5, 'IG-01': 5, 'IG-02': 4, 'IG-03': 6,
                    'IG-04': 6, 'IG-05': 3, 'IG-06': 4, 'IG-07': 5, 'CB-01': 6,
                    'CB-02': 4, 'CB-03': 5, 'CB-04': 5, 'CB-05': 4, 'CB-06': 4,
                    'CB-07': 5, 'UP-01': 5, 'UP-02': 4, 'UP-03': 4, 'UP-04': 5
                },
                recommendations: [
                    {
                        title: 'Enhance Analytical Thinking',
                        description: 'Consider taking time to gather more data before making decisions in complex situations.'
                    },
                    {
                        title: 'Leverage Your Intuition',
                        description: 'Your strong intuitive abilities can be valuable in fast-paced environments.'
                    },
                    {
                        title: 'Build Collaborative Skills',
                        description: 'Work on involving team members more in decision-making processes.'
                    }
                ]
            };

            console.log('ðŸ“Š Created test results:', testResults);

            // Store the results in localStorage
            const localStorageKey = `assessment_results_${userId}`;
            localStorage.setItem(localStorageKey, JSON.stringify(testResults));
            console.log('ðŸ’¾ Stored test results in localStorage with key:', localStorageKey);

            // Load and display the results
            loadAssessmentResults();
        }
        window.createTestResults = createTestResults;

        // Test function for getCurrentUser
        window.testGetCurrentUser = async function() {
            console.log('ðŸ§ª Testing getCurrentUserId function...');
            try {
                if (!window.assessmentStateManager) {
                    console.error('âŒ assessmentStateManager is not available');
                    alert('Assessment State Manager is not initialized. Please refresh the page and try again.');
                    return;
                }
                
                const userId = window.assessmentStateManager.getCurrentUserId();
                console.log('ðŸ‘¤ getCurrentUserId result:', userId);
                alert(`Current user ID: ${userId || 'No user ID found'}`);
            } catch (error) {
                console.error('âŒ Error in getCurrentUserId:', error);
                alert('Error getting current user ID: ' + error.message);
            }
        };

        // Update showSection to set the hash
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all sidebar items
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            sidebarItems.forEach(item => {
                item.classList.remove('active');
            });

            // Show the selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
                // Special handling for different sections
                if (sectionId === 'dashboardResultsSection') {
                    loadAssessmentResults();
                } else if (sectionId === 'profileSection') {
                    loadUserProfile();
                }
                // Set the hash
                window.location.hash = '#' + sectionId;
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'auto' });
            }

            // Add active class to the corresponding sidebar item
            const activeSidebarItem = document.querySelector(`[data-section="${sectionId}"]`);
            if (activeSidebarItem) {
                activeSidebarItem.classList.add('active');
            }
        }

        // On page load, show section from hash if present, otherwise show default
        document.addEventListener('DOMContentLoaded', function() {
            const hash = window.location.hash.replace('#', '');
            if (hash && document.getElementById(hash)) {
                showSection(hash);
            } else {
                showSection('myDecisionsSection'); // Set My Decisions as default for demo
            }
        });

        // Listen for hash changes (browser navigation)
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.replace('#', '');
            if (hash && document.getElementById(hash)) {
                showSection(hash);
            }
        });

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ DOM Content Loaded - Initializing dashboard...');
            
            // Hide loading state
            const loadingState = document.getElementById('loadingState');
            if (loadingState) {
                loadingState.style.display = 'none';
            }
            
            // Show the overview section by default
            showSection('overviewSection');
            
            // Set up navigation event listeners
            const navItems = document.querySelectorAll('.sidebar-item');
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        showSection(sectionId);
                    }
                });
            });

            console.log('âœ… Dashboard initialization complete');
        });

        // Start new assessment function
        function startNewAssessment() {
            console.log('ðŸš€ Starting new assessment...');
            showSection('validAssessmentSection');
        }

        // Sign out function for dashboard
        window.signOut = async function() {
            try {
                // Try to sign out from Supabase if available
                if (window.supabase && window.supabase.auth && window.supabase.auth.signOut) {
                    await window.supabase.auth.signOut();
                } else if (window.sessionManager && window.sessionManager.endSession) {
                    // Fallback: end session using sessionManager
                    await window.sessionManager.endSession('User logout');
                } else {
                    // Fallback: clear storage and redirect
                    sessionStorage.clear();
                    localStorage.clear();
                }
                
                // Redirect to login page
                window.location.href = '/login.html';
            } catch (error) {
                console.error('âŒ Error during sign out:', error);
                alert('Error signing out: ' + (error.message || error));
            }
        };

        // === TEAM MANAGEMENT DEMO DATA & RENDERING ===
        const teamMembers = [
            { id: 1, name: 'Sarah Johnson', email: 'sarah.johnson@company.com', department: 'Executive', role: 'CEO', assessments: 3, lastAssessment: '2024-01-15', status: 'active' },
            { id: 2, name: 'Michael Chen', email: 'michael.chen@company.com', department: 'IT', role: 'CTO', assessments: 2, lastAssessment: '2024-01-10', status: 'active' },
            { id: 3, name: 'Emily Rodriguez', email: 'emily.rodriguez@company.com', department: 'HR', role: 'HR Director', assessments: 4, lastAssessment: '2024-01-12', status: 'active' },
            { id: 4, name: 'David Kim', email: 'david.kim@company.com', department: 'Finance', role: 'CFO', assessments: 2, lastAssessment: '2024-01-08', status: 'active' },
            { id: 5, name: 'Lisa Thompson', email: 'lisa.thompson@company.com', department: 'Marketing', role: 'Marketing Manager', assessments: 1, lastAssessment: '2024-01-05', status: 'pending' }
        ];

        function renderTeamMembers(members) {
            const teamGrid = document.getElementById('teamGrid');
            if (!teamGrid) return;
            teamGrid.innerHTML = members.map(member => `
                <div class="team-member">
                    <div class="team-member-header">
                        <div class="member-avatar">${member.name.split(' ').map(n => n[0]).join('')}</div>
                        <div class="member-info">
                            <h4>${member.name}</h4>
                            <p>${member.role}</p>
                            <div class="member-department">${member.department}</div>
                        </div>
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">
                        ${member.assessments} assessments â€¢ Last: ${member.lastAssessment}
                    </div>
                    <div class="member-actions">
                        <div class="left-actions">
                            <button class="btn btn-tiny btn-secondary" title="View" onclick="alert('Viewing profile for ${member.name}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-tiny btn-secondary" title="Edit" onclick="alert('Edit ${member.name}&#39;s information')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div class="right-actions">
                            <button class="btn btn-tiny btn-secondary" title="Compare" onclick="alert('Compare results with ${member.name}')">
                                <i class="fas fa-balance-scale"></i> <span style="margin-left: 0.3em;">Compare</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterTeamByDepartment() {
            const filter = document.getElementById('departmentFilter').value;
            const filtered = filter ? teamMembers.filter(m => m.department === filter) : teamMembers;
            renderTeamMembers(filtered);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...
            // Render team members on load
            renderTeamMembers(teamMembers);
        });

        // Scenario descriptions
        const scenarioDescriptions = {
            general: 'Your overall decision-making style across all contexts',
            work: 'How you approach decisions in professional settings',
            leadership: 'Your decision-making style when leading teams or projects',
            personal: 'How you make decisions in personal and life situations',
            crisis: 'Your decision-making under pressure or in urgent situations',
            innovation: 'How you approach decisions involving change or new ideas',
            collaboration: 'Your decision-making style in collaborative environments',
            strategic: 'How you approach long-term strategic decisions'
        };

        // Change scenario function
        function changeScenario(scenarioKey) {
            console.log('ðŸ”„ Changing scenario to:', scenarioKey);
            
            // Update scenario description
            const descriptionElement = document.getElementById('scenarioDescription');
            if (descriptionElement) {
                descriptionElement.textContent = scenarioDescriptions[scenarioKey] || scenarioDescriptions.general;
            }
            
            // Get current results data
            const currentUser = window.assessmentStateManager?.getCurrentUserId();
            if (!currentUser) return;
            
            const localStorageKey = `assessment_results_${currentUser}`;
            const storedResults = localStorage.getItem(localStorageKey);
            
            if (storedResults) {
                const results = JSON.parse(storedResults);
                
                // Calculate context-specific scores if we have answers
                if (results.answers && scenarioKey !== 'general') {
                    calculateContextScores(results.answers, scenarioKey).then(contextScores => {
                        const updatedResults = {
                            ...results,
                            scores: contextScores,
                            currentScenario: scenarioKey
                        };
                        renderDashboardResultsUI(updatedResults);
                    }).catch(error => {
                        console.error('Error calculating context scores:', error);
                        // Fallback to general scores
                        renderDashboardResultsUI(results);
                    });
                } else {
                    // Use general scores or existing scores
                    renderDashboardResultsUI(results);
                }
            }
        }

        // Calculate context scores (simplified version)
        async function calculateContextScores(answers, context) {
            // This is a simplified version - in a real implementation, you'd import the full scenarios module
            const baseScores = {
                V: 0, A: 0, L: 0, I: 0, D: 0
            };
            
            // Simple context adjustments
            const contextAdjustments = {
                work: { V: 1.1, A: 0.9, L: 0.8, I: 1.3, D: 0.9 },
                leadership: { V: 1.0, A: 1.4, L: 1.0, I: 1.0, D: 1.3 },
                personal: { V: 0.8, A: 1.0, L: 1.4, I: 0.8, D: 1.3 },
                crisis: { V: 1.3, A: 0.9, L: 1.2, I: 0.8, D: 0.7 },
                innovation: { V: 0.9, A: 1.2, L: 1.3, I: 0.8, D: 1.5 },
                collaboration: { V: 0.9, A: 1.4, L: 1.1, I: 0.9, D: 1.0 },
                strategic: { V: 1.2, A: 1.0, L: 0.9, I: 1.1, D: 1.3 }
            };
            
            // Apply context adjustments to base scores
            const adjustment = contextAdjustments[context] || { V: 1, A: 1, L: 1, I: 1, D: 1 };
            
            // For demo purposes, use some sample scores and apply adjustments
            const sampleScores = { V: 78, A: 82, L: 75, I: 88, D: 80 };
            
            Object.keys(baseScores).forEach(dimension => {
                baseScores[dimension] = Math.round(sampleScores[dimension] * adjustment[dimension]);
                // Ensure scores stay within 0-100 range
                baseScores[dimension] = Math.max(0, Math.min(100, baseScores[dimension]));
            });
            
            return baseScores;
        }

        // Make changeScenario globally available
        window.changeScenario = changeScenario;

        // Profile Management Functions
        async function loadUserProfile() {
            try {
                console.log('ðŸ”„ Loading user profile...');
                
                // Check if user is authenticated
                let user = null;
                try {
                    if (window.supabase && window.supabase.auth) {
                        const { data: { user: authUser } } = await supabase.auth.getUser();
                        user = authUser;
                        console.log('ðŸ‘¤ Authenticated user found:', user?.id);
                    }
                } catch (authError) {
                    console.log('ðŸ” No authenticated user found, checking demo profile');
                }

                if (user) {
                    // Load from Supabase for authenticated users
                    console.log('ðŸ“¥ Loading from Supabase...');
                    const { data: profile, error } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('user_id', user.id)
                        .single();

                    if (error && error.code !== 'PGRST116') {
                        console.error('âŒ Error fetching profile from Supabase:', error);
                        populateProfileWithDemoData();
                        return;
                    }

                    if (profile) {
                        console.log('âœ… Profile loaded from Supabase:', profile);
                        populateProfileForm(profile);
                        updateProfileSummary(profile);
                    } else {
                        // Create default profile for new user
                        const defaultProfile = {
                            user_id: user.id,
                            first_name: user.user_metadata?.full_name?.split(' ')[0] || '',
                            last_name: user.user_metadata?.full_name?.split(' ').slice(1).join(' ') || '',
                            email: user.email,
                            role: '',
                            department: '',
                            organization: '',
                            phone: '',
                            bio: ''
                        };
                        console.log('ðŸ“ Creating default profile for new user:', defaultProfile);
                        populateProfileForm(defaultProfile);
                        updateProfileSummary(defaultProfile);
                    }
                } else {
                    // Load from localStorage for demo users
                    console.log('ðŸ“¥ Loading from localStorage (demo mode)...');
                    const demoProfile = localStorage.getItem('demoUserProfile');
                    
                    if (demoProfile) {
                        try {
                            const profile = JSON.parse(demoProfile);
                            console.log('âœ… Demo profile loaded from localStorage:', profile);
                            populateProfileForm(profile);
                            updateProfileSummary(profile);
                        } catch (parseError) {
                            console.error('âŒ Error parsing demo profile:', parseError);
                            populateProfileWithDemoData();
                        }
                    } else {
                        console.log('ðŸ“ No demo profile found, using default demo data');
                        populateProfileWithDemoData();
                    }
                }
            } catch (error) {
                console.error('âŒ Unexpected error loading profile:', error);
                populateProfileWithDemoData();
            }
        }

        function populateProfileWithDemoData() {
            const demoProfile = {
                first_name: 'Demo',
                last_name: 'User',
                email: 'demo@example.com',
                role: 'Manager',
                department: 'Operations',
                organization: 'Demo Corp',
                phone: '+1 (555) 123-4567',
                bio: 'This is a demo profile for testing purposes.'
            };
            populateProfileForm(demoProfile);
            updateProfileSummary(demoProfile);
        }

        function populateProfileForm(profile) {
            const form = document.getElementById('profileForm');
            if (!form) return;

            // Populate form fields
            Object.keys(profile).forEach(key => {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    field.value = profile[key] || '';
                }
            });

            // Update profile initials based on name
            updateProfileInitials(profile.first_name, profile.last_name);
        }

        function updateProfileSummary(profile) {
            const summaryCard = document.querySelector('.profile-summary-card');
            if (!summaryCard) return;

            const nameElement = summaryCard.querySelector('.profile-info h3');
            const emailElement = summaryCard.querySelector('.profile-info p:first-of-type');
            const roleElement = summaryCard.querySelector('.profile-info p:last-of-type');

            if (nameElement) {
                nameElement.textContent = `${profile.first_name} ${profile.last_name}`.trim() || 'User';
            }
            if (emailElement) {
                emailElement.textContent = profile.email || 'No email provided';
            }
            if (roleElement) {
                roleElement.textContent = profile.role ? `${profile.role} at ${profile.organization}` : 'Role not specified';
            }

            // Update profile initials in the summary card as well
            const summaryInitials = summaryCard.querySelector('.avatar-placeholder');
            if (summaryInitials) {
                const firstInitial = profile.first_name ? profile.first_name.charAt(0).toUpperCase() : '';
                const lastInitial = profile.last_name ? profile.last_name.charAt(0).toUpperCase() : '';
                const initials = (firstInitial + lastInitial) || 'U';
                summaryInitials.textContent = initials;
            }
        }

        async function saveProfile() {
            try {
                console.log('ðŸ”„ Starting profile save...');
                
                const form = document.getElementById('profileForm');
                if (!form) {
                    console.error('âŒ Profile form not found');
                    showProfileMessage('Profile form not found', 'error');
                    return;
                }

                const formData = new FormData(form);
                const profileData = Object.fromEntries(formData.entries());
                
                console.log('ðŸ“ Profile data to save:', profileData);

                // Check if user is authenticated
                let user = null;
                try {
                    if (window.supabase && window.supabase.auth) {
                        const { data: { user: authUser } } = await supabase.auth.getUser();
                        user = authUser;
                        console.log('ðŸ‘¤ Authenticated user found:', user?.id);
                    }
                } catch (authError) {
                    console.log('ðŸ” No authenticated user found, using demo mode');
                }

                if (user) {
                    // Save to Supabase for authenticated users
                    console.log('ðŸ’¾ Saving to Supabase...');
                    const { error } = await supabase
                        .from('user_profiles')
                        .upsert({
                            user_id: user.id,
                            ...profileData
                        });

                    if (error) {
                        console.error('âŒ Supabase save error:', error);
                        showProfileMessage('Error saving profile to database', 'error');
                        return;
                    }
                    
                    console.log('âœ… Profile saved to Supabase successfully');
                } else {
                    // Save to localStorage for demo users
                    console.log('ðŸ’¾ Saving to localStorage (demo mode)...');
                    try {
                        localStorage.setItem('demoUserProfile', JSON.stringify(profileData));
                        console.log('âœ… Profile saved to localStorage successfully');
                    } catch (storageError) {
                        console.error('âŒ localStorage save error:', storageError);
                        showProfileMessage('Error saving profile to local storage', 'error');
                        return;
                    }
                }

                // Update the profile summary display
                updateProfileSummary(profileData);
                
                // Show success message
                showProfileMessage('Profile saved successfully!', 'success');
                
                console.log('âœ… Profile save completed successfully');
                
            } catch (error) {
                console.error('âŒ Unexpected error saving profile:', error);
                showProfileMessage('Unexpected error saving profile', 'error');
            }
        }

        function showProfileMessage(message, type) {
            const profileSection = document.getElementById('profileSection');
            if (!profileSection) return;

            // Remove existing messages
            const existingMessage = profileSection.querySelector('.profile-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `profile-message ${type}`;
            messageDiv.textContent = message;

            // Insert at the top of the profile section
            const firstChild = profileSection.firstElementChild;
            profileSection.insertBefore(messageDiv, firstChild);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Initialize profile when section is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for profile form
            const saveBtn = document.getElementById('saveProfileBtn');
            const cancelBtn = document.getElementById('cancelProfileBtn');

            if (saveBtn) {
                saveBtn.addEventListener('click', saveProfile);
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    loadUserProfile(); // Reload original data
                    showProfileMessage('Changes cancelled', 'error');
                });
            }

            // Profile picture functionality
            initializeProfilePicture();

            // Add real-time initials update
            const firstNameField = document.getElementById('first_name');
            const lastNameField = document.getElementById('last_name');

            if (firstNameField) {
                firstNameField.addEventListener('input', updateInitialsFromForm);
            }
            if (lastNameField) {
                lastNameField.addEventListener('input', updateInitialsFromForm);
            }
        });

        function updateInitialsFromForm() {
            const firstName = document.getElementById('first_name')?.value || '';
            const lastName = document.getElementById('last_name')?.value || '';
            updateProfileInitials(firstName, lastName);
        }

        // Profile Picture Functionality
        function initializeProfilePicture() {
            const uploadBtn = document.getElementById('uploadPictureBtn');
            const removeBtn = document.getElementById('removePictureBtn');
            const fileInput = document.getElementById('profilePictureInput');
            const preview = document.getElementById('profilePicturePreview');
            const initials = document.getElementById('profilePictureInitials');
            const initialsText = document.getElementById('profileInitialsText');

            if (uploadBtn) {
                uploadBtn.addEventListener('click', () => {
                    fileInput.click();
                });
            }

            if (removeBtn) {
                removeBtn.addEventListener('click', removeProfilePicture);
            }

            if (fileInput) {
                fileInput.addEventListener('change', handleProfilePictureUpload);
            }

            // Load existing profile picture
            loadProfilePicture();
        }

        function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showProfileMessage('Please select a valid image file', 'error');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showProfileMessage('Image file size must be less than 5MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('profilePicturePreview');
                const initials = document.getElementById('profilePictureInitials');
                const removeBtn = document.getElementById('removePictureBtn');

                preview.src = e.target.result;
                preview.style.display = 'block';
                initials.style.display = 'none';
                removeBtn.style.display = 'block';

                // Save to localStorage for immediate persistence
                localStorage.setItem('profilePicture', e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function removeProfilePicture() {
            const preview = document.getElementById('profilePicturePreview');
            const initials = document.getElementById('profilePictureInitials');
            const removeBtn = document.getElementById('removePictureBtn');
            const fileInput = document.getElementById('profilePictureInput');

            preview.style.display = 'none';
            preview.src = '';
            initials.style.display = 'flex';
            removeBtn.style.display = 'none';
            fileInput.value = '';

            // Remove from localStorage
            localStorage.removeItem('profilePicture');
        }

        function loadProfilePicture() {
            const savedPicture = localStorage.getItem('profilePicture');
            const preview = document.getElementById('profilePicturePreview');
            const initials = document.getElementById('profilePictureInitials');
            const removeBtn = document.getElementById('removePictureBtn');

            if (savedPicture) {
                preview.src = savedPicture;
                preview.style.display = 'block';
                initials.style.display = 'none';
                removeBtn.style.display = 'block';
            } else {
                preview.style.display = 'none';
                initials.style.display = 'flex';
                removeBtn.style.display = 'none';
            }
        }

        function updateProfileInitials(firstName, lastName) {
            const initialsText = document.getElementById('profileInitialsText');
            if (initialsText) {
                const firstInitial = firstName ? firstName.charAt(0).toUpperCase() : '';
                const lastInitial = lastName ? lastName.charAt(0).toUpperCase() : '';
                const initials = (firstInitial + lastInitial) || 'U';
                initialsText.textContent = initials;
            }
        }

        // Load profile when profile section is shown
        function showProfileSection() {
            loadUserProfile();
        }

        // Global function to reset assessment progress
        async function resetAssessment() {
            if (window.confirm('Are you sure you want to reset your assessment? This will erase ALL your answers and cannot be undone.')) {
                // 1. Clear local storage
                if (window.assessmentStateManager && window.assessmentStateManager.clearState) {
                    await window.assessmentStateManager.clearState();
                } else {
                    localStorage.clear();
                }
                // 2. Clear Supabase progress if logged in
                if (window.supabase && window.supabase.auth) {
                    const { data: { user } } = await window.supabase.auth.getUser();
                    if (user && user.id) {
                        try {
                            await window.supabase
                                .from('user_assessment_progress')
                                .delete()
                                .eq('user_id', user.id);
                        } catch (err) {
                            console.error('Failed to clear Supabase progress:', err);
                        }
                    }
                }
                // 3. Reload the page to start fresh
                window.location.reload();
            }
        }

        window.loadTeamDemoData = function() {
            // Demo data for client presentations
            const demoTeams = [
                {
                    id: 'demo-team-1',
                    name: 'Marketing Team',
                    description: 'Core marketing team for product launches and brand campaigns',
                    organization_name: 'Demo Corp',
                    is_external: false,
                    user_role: 'manager',
                    member_count: 8,
                    assessment_count: 6,
                    members: [
                        {
                            user_id: 'demo-user-1',
                            first_name: 'Sarah',
                            last_name: 'Johnson',
                            email: 'sarah.j@democorp.com',
                            role: 'member',
                            department: 'Marketing',
                            joined_at: '2024-01-15T10:00:00Z',
                            has_assessment: true,
                            last_assessment_date: '2024-01-20T14:30:00Z',
                            assessment_scores: {
                                verity: 75,
                                association: 60,
                                lived_experience: 85,
                                institutional: 70,
                                desire: 80
                            }
                        },
                        {
                            user_id: 'demo-user-2',
                            first_name: 'Mike',
                            last_name: 'Chen',
                            email: 'mike.chen@democorp.com',
                            role: 'member',
                            department: 'Marketing',
                            joined_at: '2024-01-16T09:00:00Z',
                            has_assessment: true,
                            last_assessment_date: '2024-01-21T11:15:00Z',
                            assessment_scores: {
                                verity: 65,
                                association: 80,
                                lived_experience: 70,
                                institutional: 85,
                                desire: 75
                            }
                        },
                        {
                            user_id: 'demo-user-3',
                            first_name: 'Emily',
                            last_name: 'Rodriguez',
                            email: 'emily.r@democorp.com',
                            role: 'member',
                            department: 'Marketing',
                            joined_at: '2024-01-17T14:00:00Z',
                            has_assessment: true,
                            last_assessment_date: '2024-01-22T16:45:00Z',
                            assessment_scores: {
                                verity: 90,
                                association: 75,
                                lived_experience: 80,
                                institutional: 85,
                                desire: 70
                            }
                        }
                    ]
                },
                {
                    id: 'demo-team-2',
                    name: 'External Partners',
                    description: 'Collaboration with external agencies and consultants',
                    organization_name: 'Partner Agency',
                    is_external: true,
                    user_role: 'member',
                    member_count: 5,
                    assessment_count: 3,
                    members: [
                        {
                            user_id: 'demo-user-4',
                            first_name: 'Alex',
                            last_name: 'Thompson',
                            email: 'alex@partneragency.com',
                            role: 'manager',
                            department: 'Strategy',
                            joined_at: '2024-01-10T08:00:00Z',
                            has_assessment: true,
                            last_assessment_date: '2024-01-18T16:45:00Z',
                            assessment_scores: {
                                verity: 85,
                                association: 90,
                                lived_experience: 75,
                                institutional: 80,
                                desire: 85
                            }
                        },
                        {
                            user_id: 'demo-user-5',
                            first_name: 'Lisa',
                            last_name: 'Wang',
                            email: 'lisa.wang@partneragency.com',
                            role: 'member',
                            department: 'Creative',
                            joined_at: '2024-01-12T11:30:00Z',
                            has_assessment: true,
                            last_assessment_date: '2024-01-19T13:20:00Z',
                            assessment_scores: {
                                verity: 70,
                                association: 85,
                                lived_experience: 90,
                                institutional: 65,
                                desire: 80
                            }
                        }
                    ]
                },
                {
                    id: 'demo-team-3',
                    name: 'Product Development',
                    description: 'Cross-functional product team including engineering, design, and product management',
                    organization_name: 'Demo Corp',
                    is_external: false,
                    user_role: 'owner',
                    member_count: 12,
                    assessment_count: 9,
                    members: [
                        {
                            user_id: 'demo-user-6',
                            first_name: 'David',
                            last_name: 'Kim',
                            email: 'david.kim@democorp.com',
                            role: 'member',
                            department: 'Engineering',
                            joined_at: '2024-01-05T09:00:00Z',
                            has_assessment: true,
                            last_assessment_date: '2024-01-15T10:30:00Z',
                            assessment_scores: {
                                verity: 95,
                                association: 70,
                                lived_experience: 60,
                                institutional: 90,
                                desire: 75
                            }
                        },
                        {
                            user_id: 'demo-user-7',
                            first_name: 'Rachel',
                            last_name: 'Green',
                            email: 'rachel.green@democorp.com',
                            role: 'member',
                            department: 'Design',
                            joined_at: '2024-01-08T13:00:00Z',
                            has_assessment: true,
                            last_assessment_date: '2024-01-16T15:45:00Z',
                            assessment_scores: {
                                verity: 80,
                                association: 85,
                                lived_experience: 90,
                                institutional: 70,
                                desire: 85
                            }
                        },
                        {
                            user_id: 'demo-user-8',
                            first_name: 'James',
                            last_name: 'Wilson',
                            email: 'james.wilson@democorp.com',
                            role: 'member',
                            department: 'Product',
                            joined_at: '2024-01-10T10:00:00Z',
                            has_assessment: false,
                            last_assessment_date: null,
                            assessment_scores: null
                        }
                    ]
                }
            ];

            // Store demo teams globally for fallback
            window.demoTeams = demoTeams;

            // Load demo data into team management
            if (window.teamManagement && window.teamManagement.renderTeams) {
                window.teamManagement.userTeams = demoTeams;
                window.teamManagement.isDemoMode = true;
                window.teamManagement.renderTeams();
                showTeamMessage('Demo data loaded successfully! You can now explore team management features.', 'success');
                
                // Update button states
                const loadBtn = document.getElementById('loadDemoDataBtn');
                const clearBtn = document.getElementById('clearDemoDataBtn');
                if (loadBtn) {
                    loadBtn.innerHTML = '<i class="fas fa-check"></i> Demo Loaded';
                    loadBtn.style.background = '#10b981';
                    loadBtn.disabled = true;
                }
                if (clearBtn) {
                    clearBtn.style.display = 'inline-block';
                }
            } else {
                // Fallback: render demo data directly
                console.log('Team management module not available, using fallback demo');
                renderFallbackDemo(demoTeams);
                showTeamMessage('Demo data loaded successfully! (Fallback mode)', 'success');
                
                // Update button states
                const loadBtn = document.getElementById('loadDemoDataBtn');
                const clearBtn = document.getElementById('clearDemoDataBtn');
                if (loadBtn) {
                    loadBtn.innerHTML = '<i class="fas fa-check"></i> Demo Loaded';
                    loadBtn.style.background = '#10b981';
                    loadBtn.disabled = true;
                }
                if (clearBtn) {
                    clearBtn.style.display = 'inline-block';
                }
            }
        };

        window.clearTeamDemoData = function() {
            if (confirm('Are you sure you want to clear the demo data? This will reset the team management section.')) {
                // Clear team management data
                if (window.teamManagement && window.teamManagement.renderTeams) {
                    window.teamManagement.userTeams = [];
                    window.teamManagement.isDemoMode = false;
                    window.teamManagement.renderTeams();
                } else {
                    // Clear fallback demo
                    const teamGrid = document.getElementById('teamGrid');
                    if (teamGrid) {
                        teamGrid.innerHTML = `
                            <div class="team-empty-state">
                                <i class="fas fa-users"></i>
                                <h3>No Teams Yet</h3>
                                <p>Create your first team or join an existing one to get started.</p>
                                <button onclick="loadTeamDemoData()" class="btn primary" style="margin-top: 1rem;">
                                    <i class="fas fa-database"></i> Load Demo Data
                                </button>
                            </div>
                        `;
                    }
                }

                // Hide team details section
                const teamDetailsSection = document.getElementById('teamDetailsSection');
                if (teamDetailsSection) {
                    teamDetailsSection.style.display = 'none';
                }

                // Reset button states
                const loadBtn = document.getElementById('loadDemoDataBtn');
                const clearBtn = document.getElementById('clearDemoDataBtn');
                if (loadBtn) {
                    loadBtn.innerHTML = '<i class="fas fa-database"></i> Load Demo Data';
                    loadBtn.style.background = '#8b5cf6';
                    loadBtn.disabled = false;
                }
                if (clearBtn) {
                    clearBtn.style.display = 'none';
                }

                // Clear global demo data
                window.demoTeams = null;

                showTeamMessage('Demo data cleared successfully!', 'info');
            }
        };

        // Fallback demo rendering function
        function renderFallbackDemo(teams) {
            const teamGrid = document.getElementById('teamGrid');
            if (!teamGrid) return;

            teamGrid.innerHTML = teams.map(team => `
                <div class="team-card ${team.is_external ? 'external-team' : ''}" onclick="selectFallbackTeam('${team.id}')">
                    <div class="team-header">
                        <h4>${team.name}</h4>
                        ${team.is_external ? '<span class="external-badge">External</span>' : ''}
                        <span class="demo-badge">Demo</span>
                    </div>
                    <p class="team-description">${team.description || 'No description'}</p>
                    <div class="team-stats">
                        <span><i class="fas fa-users"></i> ${team.member_count} members</span>
                        <span><i class="fas fa-chart-bar"></i> ${team.assessment_count} assessments</span>
                        <span><i class="fas fa-building"></i> ${team.organization_name}</span>
                    </div>
                    <div class="team-actions">
                        <button class="btn btn-primary">
                            View Team
                        </button>
                        ${team.user_role === 'owner' || team.user_role === 'manager' ? `
                            <button class="btn btn-secondary">
                                <i class="fas fa-user-plus"></i> Invite
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function selectFallbackTeam(teamId) {
            const team = window.demoTeams?.find(t => t.id === teamId);
            if (!team) return;

            document.getElementById('currentTeamName').textContent = team.name;
            document.getElementById('teamMemberCount').textContent = team.member_count;
            document.getElementById('teamAssessmentCount').textContent = team.assessment_count;
            document.getElementById('teamCompletionRate').textContent = 
                Math.round((team.assessment_count / team.member_count) * 100) + '%';

            renderFallbackMembers(team.members);
            document.getElementById('teamDetailsSection').style.display = 'block';
        }

        function renderFallbackMembers(members) {
            const memberGrid = document.getElementById('memberGrid');
            if (!memberGrid) return;

            memberGrid.innerHTML = members.map(member => `
                <div class="member-card">
                    <div class="member-avatar">
                        <div class="avatar-initials">
                            ${member.first_name ? member.first_name.charAt(0) : ''}${member.last_name ? member.last_name.charAt(0) : ''}
                        </div>
                    </div>
                    <div class="member-info">
                        <h5>${member.first_name} ${member.last_name}</h5>
                        <p class="member-email">${member.email}</p>
                        <p class="member-role">${member.role} â€¢ ${member.department || 'No department'}</p>
                    </div>
                    <div class="member-assessment">
                        ${member.has_assessment ? `
                            <div class="assessment-status completed">
                                <i class="fas fa-check-circle"></i> Completed
                            </div>
                            <button class="btn btn-small">
                                View Results
                            </button>
                        ` : `
                            <div class="assessment-status pending">
                                <i class="fas fa-clock"></i> Pending
                            </div>
                        `}
                    </div>
                </div>
            `).join('');
        }

        window.selectFallbackTeam = selectFallbackTeam;

        // My Decisions Section: Toggle form/results for demo
        function showDecisionForm() {
            document.getElementById('decisionFormPanel').style.display = 'block';
            document.getElementById('decisionResultsPanel').style.display = 'none';
        }
        function hideDecisionForm() {
            document.getElementById('decisionFormPanel').style.display = 'none';
            document.getElementById('decisionResultsPanel').style.display = 'block';
        }
        document.getElementById('decisionForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            hideDecisionForm();
        });

        // --- DEMO USER LOGIC FOR MY RESULTS SECTION ---
        function isDemoUser() {
            try {
                const demoUser = localStorage.getItem('demoUser');
                if (demoUser) {
                    const user = JSON.parse(demoUser);
                    return !!user.email;
                }
            } catch (e) {}
            return false;
        }

        function hasCompletedAssessment() {
            // This should check if real results exist for the user
            if (window.assessmentStateManager && typeof window.assessmentStateManager.hasCompletedAssessments === 'function') {
                return window.assessmentStateManager.hasCompletedAssessments();
            }
            return false;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const demoActions = document.getElementById('demoActions');
            const toggleBtn = document.getElementById('toggleDemoResultsBtn');
            if (isDemoUser() && demoActions && toggleBtn) {
                demoActions.style.display = 'flex';
                let showingDemoResults = false;
                toggleBtn.addEventListener('click', function() {
                    if (showingDemoResults) {
                        // Show real results (if any)
                        if (hasCompletedAssessment()) {
                            if (typeof loadAssessmentResults === 'function') {
                                loadAssessmentResults();
                            }
                        } else {
                            // If no real results, show empty/fallback UI
                            if (typeof renderDashboardResultsUI === 'function') {
                                renderDashboardResultsUI({ isTestData: false });
                            }
                        }
                        toggleBtn.textContent = 'ðŸ§ª Show Demo Results';
                    } else {
                        // Show demo results
                        if (typeof renderDashboardResultsUI === 'function') {
                            renderDashboardResultsUI({ isTestData: true });
                        }
                        toggleBtn.textContent = 'Show Real Results';
                    }
                    showingDemoResults = !showingDemoResults;
                });
            }
        });
    </script>

    <!-- Dummy fallback for missing getAssessmentResults to prevent errors in demo/dev mode -->
    <script>
    if (!window.assessmentStateManager) window.assessmentStateManager = {};
    if (typeof window.assessmentStateManager.getAssessmentResults !== 'function') {
        window.assessmentStateManager.getAssessmentResults = function() {
            // Return dummy data or do nothing
            return {};
        };
    }
    </script>

    <script>
    // --- FORCE DEMO USER FOR TESTING ---
    (function ensureDemoUser() {
      if (!localStorage.getItem('demoUser')) {
        localStorage.setItem('demoUser', JSON.stringify({email: 'demo@example.com'}));
      }
    })();
    
    // --- DEMO BUTTON VISIBILITY LOGIC ---
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is a demo user
        function isDemoUser() {
            try {
                const demoUser = localStorage.getItem('demoUser');
                if (demoUser) {
                    const user = JSON.parse(demoUser);
                    return !!user.email;
                }
            } catch (e) {
                console.error('Error parsing demo user:', e);
            }
            return false;
        }
        
        // Show demo actions if user is a demo user
        function showDemoActions() {
            const demoActions = document.getElementById('demoActions');
            if (demoActions && isDemoUser()) {
                demoActions.style.display = 'flex';
                console.log('âœ… Demo actions shown for demo user');
                
                // Set up toggle functionality
                const toggleBtn = document.getElementById('toggleDemoResultsBtn');
                if (toggleBtn) {
                    let showingDemoResults = false;
                    
                    toggleBtn.addEventListener('click', function() {
                        console.log('ðŸ”„ Demo toggle button clicked');
                        if (showingDemoResults) {
                            // Show real results (if any) or empty state
                            console.log('ðŸ“Š Showing real results');
                            if (typeof loadAssessmentResults === 'function') {
                                loadAssessmentResults();
                            }
                            toggleBtn.textContent = 'ðŸ§ª Show Demo Results';
                        } else {
                            // Show demo results
                            console.log('ðŸ§ª Showing demo results');
                            if (typeof renderDashboardResultsUI === 'function') {
                                // Create demo results data
                                const demoResults = {
                                    id: 'demo-assessment-' + Date.now(),
                                    userId: 'demo-user',
                                    totalScore: 85,
                                    completionDate: new Date().toLocaleDateString(),
                                    questionsAnswered: 25,
                                    scores: {
                                        'V': 78,  // Verity
                                        'A': 82,  // Association
                                        'L': 75,  // Lived Experience
                                        'I': 88,  // Institutional
                                        'D': 80   // Desire
                                    },
                                    awareness: {
                                        percent: 72,
                                        flag: false
                                    },
                                    answers: {
                                        'DT-01': 6, 'DT-02': 4, 'DT-03': 5, 'DT-04': 6, 'DT-05': 3,
                                        'DT-06': 3, 'DT-07': 5, 'IG-01': 5, 'IG-02': 4, 'IG-03': 6,
                                        'IG-04': 6, 'IG-05': 3, 'IG-06': 4, 'IG-07': 5, 'CB-01': 6,
                                        'CB-02': 4, 'CB-03': 5, 'CB-04': 5, 'CB-05': 4, 'CB-06': 4,
                                        'CB-07': 5, 'UP-01': 5, 'UP-02': 4, 'UP-03': 4, 'UP-04': 5
                                    },
                                    isTestData: true
                                };
                                renderDashboardResultsUI(demoResults);
                            }
                            toggleBtn.textContent = 'Show Real Results';
                        }
                        showingDemoResults = !showingDemoResults;
                    });
                }
            } else {
                console.log('âŒ Demo actions not shown - user is not a demo user or element not found');
            }
        }
        
        // Initialize demo actions
        showDemoActions();
        
        // Also show demo actions when My Results section is displayed
        const originalShowSection = window.showSection;
        window.showSection = function(sectionId) {
            if (originalShowSection) {
                originalShowSection(sectionId);
            }
            
            // Show demo actions when My Results section is displayed
            if (sectionId === 'dashboardResultsSection') {
                setTimeout(showDemoActions, 100); // Small delay to ensure DOM is updated
            }
        };
    });
    </script>
</body>
</html> 